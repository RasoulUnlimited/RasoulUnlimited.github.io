!function(){"use strict";if("undefined"==typeof window||"undefined"==typeof document)return;const e="ru-featured-feedback-v3::",t=[],r=new WeakMap,a=new Map;let n=!1;const o={fa:{empty:"هنوز بازخورد منتخب منتشر نشده است.",errorPrefix:"نمایش بازخوردهای منتخب ممکن نبود.",sourceCta:"مشاهده همه گفتگوها",authorFallback:"کاربر GitHub",roleFallback:"بازدیدکننده",staleNotice:"به دلیل ناپایداری اتصال، نسخه ذخیره‌شده نمایش داده شد."},en:{empty:"No featured feedback has been published yet.",errorPrefix:"Featured feedback could not be loaded.",sourceCta:"View all discussions",authorFallback:"GitHub user",roleFallback:"Visitor",staleNotice:"Showing a cached snapshot because the connection is unstable."}};function c(e){return new Promise(t=>{window.setTimeout(t,e)})}const s=function(){try{const e="__ru_featured_feedback_probe__";return localStorage.setItem(e,"1"),localStorage.removeItem(e),localStorage}catch{return null}}();function u(t){try{const r=new URL(t,window.location.href);return e+r.pathname}catch{return e+String(t||"")}}function i(t,r){if(!s||!Array.isArray(r)||!r.length)return;const a=u(t),n=JSON.stringify({t:Date.now(),items:r});try{s.setItem(a,n)}catch{!function(){if(!s)return;const t=[];for(let r=0;r<s.length;r++){const a=s.key(r);if(!a||!a.startsWith(e))continue;let n=0;try{const e=JSON.parse(s.getItem(a)||"{}");n=Number(e.t)||0}catch{n=0}t.push({key:a,timestamp:n})}t.sort((e,t)=>e.timestamp-t.timestamp).slice(0,Math.ceil(t.length/2)).forEach(e=>{try{s.removeItem(e.key)}catch{}})}();try{s.setItem(a,n)}catch{}}}function d(e){if("string"!=typeof e||!e.trim())return!1;try{const t=new URL(e,window.location.href);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}function l(e,t=800){if("string"!=typeof e)return"";const r=e.replace(/\s+/g," ").trim();return r?r.slice(0,t):""}function f(e,t,r){try{e.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:r||{}}))}catch{}}function m(e,t){const r=document.createElement("p");r.className="featured-feedback-stale-note",r.textContent=t.staleNotice,e.appendChild(r)}function h(e,t,r,a){const n=document.createElement("article");n.className="featured-feedback-card",n.setAttribute("data-featured-feedback-item",e.id||""),n.setAttribute("data-feedback-lang",t);const o=document.createElement("p");o.className="featured-feedback-quote",o.textContent=e.quote,n.appendChild(o);const c=document.createElement("div");c.className="featured-feedback-meta";const s=document.createElement("div"),u=document.createElement("div");u.className="featured-feedback-author",u.textContent=e.author||r.authorFallback;const i=document.createElement("div");i.className="featured-feedback-role",i.textContent=e.role||r.roleFallback,s.appendChild(u),s.appendChild(i),c.appendChild(s);const l=function(e){if(d(e||""))return e;return"https://github.com/RasoulUnlimited/comments/discussions"}(a),f=document.createElement("a");f.className="featured-feedback-link",f.target="_blank",f.rel="noopener noreferrer",f.href=e.source_url||l,f.textContent=e.source_label||r.sourceCta,c.appendChild(f),n.appendChild(c);const m=function(e,t){if(!e)return"";const r=new Date(e);if(Number.isNaN(r.getTime()))return"";const a="fa"===t?"fa-IR":"en-US";try{return new Intl.DateTimeFormat(a,{year:"numeric",month:"short",day:"numeric"}).format(r)}catch{return""}}(e.date,t);if(m&&e.date){const t=document.createElement("time");t.className="featured-feedback-date",t.dateTime=e.date,t.textContent=m,n.appendChild(t)}return n}async function b(e,t){const r="function"==typeof AbortController?new AbortController:null;let a=null;r&&(a=window.setTimeout(()=>{r.abort()},t));try{return await fetch(e,{cache:"no-store",credentials:"same-origin",...r?{signal:r.signal}:{}})}finally{a&&window.clearTimeout(a)}}async function p(e,t,r){if(!e)throw new Error("missing-source");if(!r&&a.has(e))return a.get(e);r&&a.delete(e);const n=(async()=>{try{const r=await async function(e){let t=null;for(let r=1;r<=3;r++)try{const t=await b(e,6500);if(!t.ok)throw new Error(`http-${t.status}`);const r=await t.json();if(!r||!Array.isArray(r.items))throw new Error("invalid-shape");return r.items}catch(e){if(t=e,r<3){const e=320*2**(r-1)+Math.floor(120*Math.random());await c(e)}}throw t||new Error("fetch-failed")}(e),a=r.map(e=>function(e,t){if(!e||"object"!=typeof e)return null;const r=String(e.lang||"").toLowerCase(),a=r.startsWith("fa")?"fa":r.startsWith("en")?"en":t,n=l(String(e.id||""),120),o=l(String(e.quote||""),1200);if(!o)return null;const c=l(String(e.author||""),160),s=l(String(e.role||""),160),u=l(String(e.source_label||""),160),i=d(String(e.source_url||""))?String(e.source_url):"",f=l(String(e.date||""),64);return{id:n,lang:a,quote:o,author:c,role:s,source_url:i,source_label:u,date:f&&!Number.isNaN(Date.parse(f))?f:""}}(e,t)).filter(Boolean);if(!a.length)throw new Error("no-usable-items");return i(e,a),{items:a,stale:!1}}catch(t){const r=function(e){if(!s)return null;const t=u(e),r=s.getItem(t);if(!r)return null;try{const e=JSON.parse(r),a=Number(e.t)||0,n=Array.isArray(e.items)?e.items:null;return n&&n.length?Date.now()-a>216e5?(s.removeItem(t),null):n:(s.removeItem(t),null)}catch{return s.removeItem(t),null}}(e);if(r&&r.length)return{items:r,stale:!0};throw t}})();a.set(e,n);try{return await n}catch(t){throw a.delete(e),t}}function y(e){e&&e.retryTimer&&(window.clearTimeout(e.retryTimer),e.retryTimer=null)}async function w(e,t={}){if(!e)return;const a=r.get(e);if(!a)return;if("loading"===a.status)return;const n=function(e){return(e.dataset.featuredFeedbackLang||document.documentElement.lang||"en").toLowerCase().startsWith("fa")?"fa":"en"}(e),c=o[n],s=e.dataset.featuredFeedbackSource||"",u=e.dataset.featuredFeedbackFallback||"",i=!!t.forceRefresh;e.dataset.featuredFeedbackStatus="loading",e.dataset.featuredFeedbackErrorReason="",delete e.dataset.featuredFeedbackStale,a.status="loading",y(a),function(e){for(;e.firstChild;)e.removeChild(e.firstChild)}(e);try{const{items:t,stale:r}=await p(s,n,i),o=t.filter(e=>e&&e.lang===n).slice(0,3);if(!o.length)return r&&(e.dataset.featuredFeedbackStale="true",m(e,c)),function(e,t){const r=document.createElement("p");r.className="featured-feedback-empty",r.textContent=t.empty,e.appendChild(r),e.dataset.featuredFeedbackStatus="empty"}(e,c),a.status="empty",void f(e,"featured-feedback:ready",{stale:r,empty:!0});r?(e.dataset.featuredFeedbackStale="true",m(e,c)):delete e.dataset.featuredFeedbackStale,o.forEach(t=>{e.appendChild(h(t,n,c,u))}),e.dataset.featuredFeedbackStatus="ready",a.status=r?"stale":"ready",a.retryCount=0,f(e,"featured-feedback:ready",{stale:!!r,empty:!1}),r&&f(e,"featured-feedback:stale",{source:s})}catch(t){const r=String(t&&t.message?t.message:"unknown-error");!function(e,t,r,a){const n=document.createElement("p");if(n.className="featured-feedback-error",n.textContent=`${t.errorPrefix} `,d(r||"")){const e=document.createElement("a");e.className="featured-feedback-link",e.href=r,e.target="_blank",e.rel="noopener noreferrer",e.textContent=t.sourceCta,n.appendChild(e)}e.appendChild(n),e.dataset.featuredFeedbackStatus="error",e.dataset.featuredFeedbackErrorReason=a||"unknown-error",delete e.dataset.featuredFeedbackStale}(e,c,u,r),a.status="error",f(e,"featured-feedback:error",{reason:r}),function(e,t,r){if(!t)return;if(!1===navigator.onLine)return;if(t.retryCount>=2)return;t.retryCount+=1;const a=960*t.retryCount;y(t),t.retryTimer=window.setTimeout(()=>{w(e,{forceRefresh:!0,source:"auto-retry"})},a),f(e,"featured-feedback:retry",{reason:r,source:"auto",attempt:t.retryCount})}(e,a,r)}}function k(){const e=Array.from(document.querySelectorAll("[data-featured-feedback-root]"));e.length&&(e.forEach(e=>{!function(e){e&&"true"!==e.dataset.featuredFeedbackBooted&&(e.dataset.featuredFeedbackBooted="true",r.set(e,{status:"idle",retryCount:0,retryTimer:null}),t.push(e))}(e),w(e,{forceRefresh:!1,source:"init"})}),function(){if(n)return;n=!0;const e=()=>{t.forEach(e=>{const t=r.get(e);t&&("error"===t.status||"stale"===t.status||"true"===e.dataset.featuredFeedbackStale)&&w(e,{forceRefresh:!0,source:"online"})})};window.addEventListener("online",e),window.addEventListener("beforeunload",()=>{window.removeEventListener("online",e)},{once:!0})}())}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",k,{once:!0}):k(),window.__featuredFeedback={reloadAll(e=!0){t.forEach(t=>{w(t,{forceRefresh:!!e,source:"manual"})})},getStatus(e){const t=r.get(e);return t?t.status:"unknown"}}}();
//# sourceMappingURL=featured-feedback.min.js.map
