{"version":3,"file":"accordion.min.js","names":["window","document","ACCORDION_REGISTRY","Map","PREFERS_REDUCED_MOTION","matchMedia","matches","initAccordion","root","accordionId","dataset","allowMultiple","getAttribute","hasAttribute","allowToggle","itemRefs","headers","reduceMotion","items","Array","from","querySelectorAll","length","transitionEndHandlers","WeakMap","transitionTimeoutIds","clearTransitionHandlers","panel","existingHandler","get","removeEventListener","delete","timeoutId","clearTimeout","setupTransitionEnd","onEnd","finished","finish","e","handler","propertyName","addEventListener","set","setTimeout","forEach","item","index","header","querySelector","headerId","id","panelId","initiallyOpen","classList","contains","setAttribute","hidden","add","style","maxHeight","opacity","remove","push","some","ref","isItemExpanded","toggleItem","key","preventDefault","currentIndex","indexOf","focus","expandItem","collapseItem","dispatchAccordionEvent","type","event","detail","CustomEvent","bubbles","evt","createEvent","initCustomEvent","createAccordionEvent","dispatchEvent","startHeight","scrollHeight","offsetHeight","requestAnimationFrame","targetHeight","currentlyExpanded","reduce","count","otherRef","resolveRecord","accordionIdOrElement","HTMLElement","resolveItemRef","record","target","find","acc","String","Accordion","open","close","toggle","openAll","closeAll","firstOpen","init","rootOrSelector","node","size"],"sources":["accordion.js"],"mappings":"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","ignoreList":[],"sourcesContent":["// js/accordion.js\r\n(function () {\r\n  \"use strict\";\r\n\r\n  // اگر در محیطی مثل SSR/Node اجرا شد، هیچ کاری نکنیم\r\n  if (typeof window === \"undefined\" || typeof document === \"undefined\") {\r\n    return;\r\n  }\r\n\r\n  /**\r\n   * @typedef {Object} AccordionItemRefs\r\n   * @property {HTMLElement} item\r\n   * @property {HTMLElement} header\r\n   * @property {HTMLElement} panel\r\n   */\r\n\r\n  /**\r\n   * رجیستری آکاردئون‌ها برای استفاده در API سراسری\r\n   * @type {Map<string, {\r\n   *   root: HTMLElement,\r\n   *   itemRefs: AccordionItemRefs[],\r\n   *   allowMultiple: boolean,\r\n   *   allowToggle: boolean,\r\n   *   expandItem: (ref: AccordionItemRefs) => void,\r\n   *   collapseItem: (ref: AccordionItemRefs) => void,\r\n   *   toggleItem: (ref: AccordionItemRefs) => void,\r\n   *   isItemExpanded: (ref: AccordionItemRefs) => boolean\r\n   * }>}\r\n   */\r\n  const ACCORDION_REGISTRY = new Map();\r\n\r\n  // ترجیح کاربر برای کاهش انیمیشن فقط یک بار محاسبه می‌شود\r\n  const PREFERS_REDUCED_MOTION =\r\n    !!(window.matchMedia &&\r\n      window.matchMedia(\"(prefers-reduced-motion: reduce)\").matches);\r\n\r\n  // مدت‌زمان fallback برای ترنزیشن‌ها (باید با transition CSS تقریباً هماهنگ باشد)\r\n  const TRANSITION_FALLBACK_MS = 500;\r\n\r\n  /**\r\n   * سازنده‌ی امن CustomEvent برای مرورگرهای قدیمی‌تر\r\n   * @param {string} type\r\n   * @param {any} detail\r\n   * @returns {CustomEvent}\r\n   */\r\n  function createAccordionEvent(type, detail) {\r\n    if (typeof window.CustomEvent === \"function\") {\r\n      return new CustomEvent(type, {\r\n        bubbles: true,\r\n        detail,\r\n      });\r\n    }\r\n    const evt = document.createEvent(\"CustomEvent\");\r\n    evt.initCustomEvent(type, true, false, detail);\r\n    return evt;\r\n  }\r\n\r\n  /**\r\n   * Initialize a single accordion container.\r\n   * @param {HTMLElement} root\r\n   */\r\n  function initAccordion(root) {\r\n    if (!root) return;\r\n\r\n    const accordionId = root.dataset.accordionId || \"main\";\r\n\r\n    const allowMultiple =\r\n      root.getAttribute(\"data-allow-multiple\") === \"true\" ||\r\n      root.hasAttribute(\"data-allow-multiple\");\r\n\r\n    const allowToggle =\r\n      root.getAttribute(\"data-allow-toggle\") !== \"false\"; // اگر false باشد، حداقل یک آیتم همیشه باز می‌ماند\r\n\r\n    /** @type {AccordionItemRefs[]} */\r\n    const itemRefs = [];\r\n    /** @type {HTMLElement[]} */\r\n    const headers = [];\r\n\r\n    const reduceMotion = PREFERS_REDUCED_MOTION;\r\n\r\n    const items = Array.from(root.querySelectorAll(\".accordion-item\"));\r\n    if (!items.length) return;\r\n\r\n    // برای نگه‌داری هندلرهای transitionend و timeoutها\r\n    /** @type {WeakMap<HTMLElement, (e: TransitionEvent) => void>} */\r\n    const transitionEndHandlers = new WeakMap();\r\n    /** @type {WeakMap<HTMLElement, number>} */\r\n    const transitionTimeoutIds = new WeakMap();\r\n\r\n    /**\r\n     * پاک کردن هندلر transitionend و timeout از پنل\r\n     * @param {HTMLElement} panel\r\n     */\r\n    function clearTransitionHandlers(panel) {\r\n      const existingHandler = transitionEndHandlers.get(panel);\r\n      if (existingHandler) {\r\n        panel.removeEventListener(\"transitionend\", existingHandler);\r\n        transitionEndHandlers.delete(panel);\r\n      }\r\n      const timeoutId = transitionTimeoutIds.get(panel);\r\n      if (timeoutId != null) {\r\n        clearTimeout(timeoutId);\r\n        transitionTimeoutIds.delete(panel);\r\n      }\r\n    }\r\n\r\n    /**\r\n     * ثبت هندلر transitionend + fallback timeout روی پنل\r\n     * @param {HTMLElement} panel\r\n     * @param {(e?: TransitionEvent) => void} onEnd\r\n     */\r\n    function setupTransitionEnd(panel, onEnd) {\r\n      clearTransitionHandlers(panel);\r\n\r\n      let finished = false;\r\n\r\n      function finish(e) {\r\n        if (finished) return;\r\n        finished = true;\r\n        clearTransitionHandlers(panel);\r\n        onEnd(e);\r\n      }\r\n\r\n      const handler = (e) => {\r\n        if (e.propertyName === \"max-height\") {\r\n          finish(e);\r\n        }\r\n      };\r\n\r\n      panel.addEventListener(\"transitionend\", handler);\r\n      transitionEndHandlers.set(panel, handler);\r\n\r\n      const timeoutId = window.setTimeout(() => {\r\n        finish();\r\n      }, TRANSITION_FALLBACK_MS);\r\n      transitionTimeoutIds.set(panel, timeoutId);\r\n    }\r\n\r\n    // --- First pass: setup ARIA / state ---\r\n    items.forEach((item, index) => {\r\n      const header = /** @type {HTMLElement|null} */ (\r\n        item.querySelector(\".accordion-header\")\r\n      );\r\n      const panel = /** @type {HTMLElement|null} */ (\r\n        item.querySelector(\".accordion-content\")\r\n      );\r\n\r\n      if (!header || !panel) return;\r\n\r\n      const headerId = header.id || `accordion-header-${accordionId}-${index}`;\r\n      const panelId = panel.id || `accordion-panel-${accordionId}-${index}`;\r\n\r\n      header.id = headerId;\r\n      panel.id = panelId;\r\n\r\n      const initiallyOpen =\r\n        item.classList.contains(\"is-open\") || item.hasAttribute(\"data-open\");\r\n\r\n      // ARIA wiring\r\n      header.setAttribute(\"role\", \"button\");\r\n      header.setAttribute(\"aria-controls\", panelId);\r\n      header.setAttribute(\"aria-expanded\", initiallyOpen ? \"true\" : \"false\");\r\n      header.setAttribute(\"tabindex\", \"0\");\r\n\r\n      panel.setAttribute(\"role\", \"region\");\r\n      panel.setAttribute(\"aria-labelledby\", headerId);\r\n      panel.setAttribute(\"aria-hidden\", initiallyOpen ? \"false\" : \"true\");\r\n      panel.hidden = !initiallyOpen;\r\n\r\n      if (initiallyOpen) {\r\n        item.classList.add(\"is-open\");\r\n        panel.style.maxHeight = \"none\";\r\n        panel.style.opacity = \"1\";\r\n      } else {\r\n        item.classList.remove(\"is-open\");\r\n        panel.style.maxHeight = \"0px\";\r\n        panel.style.opacity = \"0\";\r\n      }\r\n\r\n      headers.push(header);\r\n      itemRefs.push({ item, header, panel });\r\n    });\r\n\r\n    if (!itemRefs.length) return;\r\n\r\n    /**\r\n     * Dispatch a custom event from an item.\r\n     * @param {HTMLElement} item\r\n     * @param {string} type\r\n     * @param {string} accordionId\r\n     */\r\n    function dispatchAccordionEvent(item, type, accordionId) {\r\n      if (!item) return;\r\n      const event = createAccordionEvent(type, { item, accordionId });\r\n      item.dispatchEvent(event);\r\n    }\r\n\r\n    /**\r\n     * Check if an item is expanded.\r\n     * @param {AccordionItemRefs} ref\r\n     * @returns {boolean}\r\n     */\r\n    function isItemExpanded(ref) {\r\n      return ref.header.getAttribute(\"aria-expanded\") === \"true\";\r\n    }\r\n\r\n    /**\r\n     * تعداد آیتم‌های باز در این آکاردئون.\r\n     * @returns {number}\r\n     */\r\n    function getExpandedCount() {\r\n      return itemRefs.reduce(\r\n        (count, ref) => (isItemExpanded(ref) ? count + 1 : count),\r\n        0\r\n      );\r\n    }\r\n\r\n    // اگر اجازه‌ی toggle نداریم، مطمئن شو حداقل یک آیتم از ابتدا باز است\r\n    if (!allowToggle) {\r\n      const hasOpen = itemRefs.some((ref) => isItemExpanded(ref));\r\n      if (!hasOpen && itemRefs[0]) {\r\n        const { item, header, panel } = itemRefs[0];\r\n        header.setAttribute(\"aria-expanded\", \"true\");\r\n        item.classList.add(\"is-open\");\r\n        panel.setAttribute(\"aria-hidden\", \"false\");\r\n        panel.hidden = false;\r\n        panel.style.maxHeight = \"none\";\r\n        panel.style.opacity = \"1\";\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Collapse a single item.\r\n     * @param {AccordionItemRefs} ref\r\n     */\r\n    function collapseItem(ref) {\r\n      const { item, header, panel } = ref;\r\n      if (!header || !panel) return;\r\n\r\n      header.setAttribute(\"aria-expanded\", \"false\");\r\n      item.classList.remove(\"is-open\");\r\n      panel.setAttribute(\"aria-hidden\", \"true\");\r\n\r\n      // پاک کردن هر هندلر قبلی\r\n      clearTransitionHandlers(panel);\r\n\r\n      if (reduceMotion) {\r\n        // بدون انیمیشن\r\n        panel.style.maxHeight = \"0px\";\r\n        panel.style.opacity = \"0\";\r\n        panel.hidden = true;\r\n      } else {\r\n        // مطمئن شو برای محاسبه scrollHeight مخفی نیست\r\n        panel.hidden = false;\r\n\r\n        // همیشه از ارتفاع واقعی فعلی شروع می‌کنیم\r\n        const startHeight = panel.scrollHeight;\r\n        panel.style.maxHeight = startHeight + \"px\";\r\n\r\n        // Force reflow\r\n        void panel.offsetHeight;\r\n\r\n        setupTransitionEnd(panel, () => {\r\n          // بعد از پایان انیمیشن، واقعاً مخفی‌اش می‌کنیم\r\n          panel.hidden = true;\r\n          panel.style.maxHeight = \"0px\";\r\n        });\r\n\r\n        requestAnimationFrame(() => {\r\n          panel.style.maxHeight = \"0px\";\r\n          panel.style.opacity = \"0\";\r\n        });\r\n      }\r\n\r\n      dispatchAccordionEvent(item, \"accordion:collapse\", accordionId);\r\n    }\r\n\r\n    /**\r\n     * Expand a single item.\r\n     * @param {AccordionItemRefs} ref\r\n     */\r\n    function expandItem(ref) {\r\n      const { item, header, panel } = ref;\r\n      if (!header || !panel) return;\r\n\r\n      header.setAttribute(\"aria-expanded\", \"true\");\r\n      item.classList.add(\"is-open\");\r\n      panel.setAttribute(\"aria-hidden\", \"false\");\r\n      panel.hidden = false;\r\n\r\n      if (reduceMotion) {\r\n        panel.style.maxHeight = \"none\";\r\n        panel.style.opacity = \"1\";\r\n      } else {\r\n        // از ارتفاع صفر شروع می‌کنیم، بعد به scrollHeight انیمیت می‌کنیم\r\n        panel.style.maxHeight = \"0px\";\r\n        panel.style.opacity = \"0\";\r\n\r\n        clearTransitionHandlers(panel);\r\n\r\n        setupTransitionEnd(panel, () => {\r\n          // بعد از انیمیشن، max-height را none می‌کنیم تا محتوا آزادانه رشد کند\r\n          panel.style.maxHeight = \"none\";\r\n        });\r\n\r\n        requestAnimationFrame(() => {\r\n          const targetHeight = panel.scrollHeight;\r\n          panel.style.maxHeight = targetHeight + \"px\";\r\n          panel.style.opacity = \"1\";\r\n        });\r\n      }\r\n\r\n      dispatchAccordionEvent(item, \"accordion:expand\", accordionId);\r\n    }\r\n\r\n    /**\r\n     * Toggle one accordion item\r\n     * @param {AccordionItemRefs} ref\r\n     */\r\n    function toggleItem(ref) {\r\n      const { item } = ref;\r\n      const currentlyExpanded = isItemExpanded(ref);\r\n\r\n      // اگر اجازه‌ی toggle نداریم و این تنها آیتم باز است، نبندش\r\n      if (!allowToggle && currentlyExpanded && getExpandedCount() <= 1) {\r\n        return;\r\n      }\r\n\r\n      if (!allowMultiple) {\r\n        itemRefs.forEach((otherRef) => {\r\n          if (otherRef.item === item) return;\r\n          if (isItemExpanded(otherRef)) {\r\n            collapseItem(otherRef);\r\n          }\r\n        });\r\n      }\r\n\r\n      if (currentlyExpanded) {\r\n        collapseItem(ref);\r\n      } else {\r\n        expandItem(ref);\r\n      }\r\n    }\r\n\r\n    // --- Events: click + keyboard ---\r\n\r\n    itemRefs.forEach((ref) => {\r\n      const { header } = ref;\r\n\r\n      // Click handler\r\n      header.addEventListener(\"click\", () => {\r\n        if (header.hasAttribute(\"aria-disabled\")) return;\r\n        toggleItem(ref);\r\n      });\r\n\r\n      // Keyboard handler\r\n      header.addEventListener(\"keydown\", (e) => {\r\n        const key = e.key;\r\n\r\n        if (header.hasAttribute(\"aria-disabled\")) return;\r\n\r\n        if (key === \"Enter\" || key === \" \") {\r\n          e.preventDefault();\r\n          toggleItem(ref);\r\n          return;\r\n        }\r\n\r\n        const currentIndex = headers.indexOf(header);\r\n        if (currentIndex === -1) return;\r\n\r\n        if (key === \"ArrowDown\") {\r\n          e.preventDefault();\r\n          const next = headers[currentIndex + 1] || headers[0];\r\n          next.focus();\r\n        } else if (key === \"ArrowUp\") {\r\n          e.preventDefault();\r\n          const prev = headers[currentIndex - 1] || headers[headers.length - 1];\r\n          prev.focus();\r\n        } else if (key === \"Home\") {\r\n          e.preventDefault();\r\n          headers[0].focus();\r\n        } else if (key === \"End\") {\r\n          e.preventDefault();\r\n          headers[headers.length - 1].focus();\r\n        }\r\n      });\r\n    });\r\n\r\n    // ثبت در رجیستری برای استفاده‌ی API بیرونی\r\n    ACCORDION_REGISTRY.set(accordionId, {\r\n      root,\r\n      itemRefs,\r\n      allowMultiple,\r\n      allowToggle,\r\n      expandItem,\r\n      collapseItem,\r\n      toggleItem,\r\n      isItemExpanded,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Resolve registry record by id or element.\r\n   * @param {string | HTMLElement} accordionIdOrElement\r\n   */\r\n  function resolveRecord(accordionIdOrElement) {\r\n    if (!accordionIdOrElement) return null;\r\n\r\n    if (typeof accordionIdOrElement === \"string\") {\r\n      return ACCORDION_REGISTRY.get(accordionIdOrElement) || null;\r\n    }\r\n\r\n    if (accordionIdOrElement instanceof HTMLElement) {\r\n      const id = accordionIdOrElement.dataset\r\n        ? accordionIdOrElement.dataset.accordionId\r\n        : null;\r\n      if (!id) return null;\r\n      return ACCORDION_REGISTRY.get(id) || null;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Resolve item ref by index or id.\r\n   * @param {ReturnType<typeof resolveRecord>} record\r\n   * @param {number | string} target\r\n   * @returns {AccordionItemRefs | null}\r\n   */\r\n  function resolveItemRef(record, target) {\r\n    if (!record || target == null) return null;\r\n    const { itemRefs } = record;\r\n\r\n    if (typeof target === \"number\") {\r\n      return itemRefs[target] || null;\r\n    }\r\n\r\n    if (typeof target === \"string\") {\r\n      return (\r\n        itemRefs.find(\r\n          (ref) =>\r\n            ref.item.id === target ||\r\n            ref.header.id === target ||\r\n            ref.panel.id === target\r\n        ) || null\r\n      );\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  // Auto-init on DOMContentLoaded\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    const accordions = document.querySelectorAll(\".accordion\");\r\n    accordions.forEach((acc, index) => {\r\n      if (!acc.dataset.accordionId) {\r\n        acc.dataset.accordionId = String(index + 1);\r\n      }\r\n      initAccordion(acc);\r\n    });\r\n  });\r\n\r\n  // --- Global API ---\r\n  /**\r\n   * @typedef {Object} AccordionGlobalAPI\r\n   * @property {(accordionIdOrElement: string | HTMLElement, target: number | string) => void} open\r\n   * @property {(accordionIdOrElement: string | HTMLElement, target: number | string) => void} close\r\n   * @property {(accordionIdOrElement: string | HTMLElement, target: number | string) => void} toggle\r\n   * @property {(accordionIdOrElement: string | HTMLElement) => void} openAll\r\n   * @property {(accordionIdOrElement: string | HTMLElement) => void} closeAll\r\n   * @property {(rootOrSelector: string | HTMLElement) => void} init\r\n   */\r\n\r\n  /** @type {AccordionGlobalAPI & typeof window.Accordion} */\r\n  window.Accordion = window.Accordion || {};\r\n\r\n  /**\r\n   * باز کردن یک آیتم\r\n   */\r\n  window.Accordion.open = function (accordionIdOrElement, target) {\r\n    const record = resolveRecord(accordionIdOrElement);\r\n    if (!record) return;\r\n    const ref = resolveItemRef(record, target);\r\n    if (!ref) return;\r\n    record.expandItem(ref);\r\n  };\r\n\r\n  /**\r\n   * بستن یک آیتم\r\n   */\r\n  window.Accordion.close = function (accordionIdOrElement, target) {\r\n    const record = resolveRecord(accordionIdOrElement);\r\n    if (!record) return;\r\n    const ref = resolveItemRef(record, target);\r\n    if (!ref) return;\r\n    record.collapseItem(ref);\r\n  };\r\n\r\n  /**\r\n   * تغییر وضعیت یک آیتم\r\n   */\r\n  window.Accordion.toggle = function (accordionIdOrElement, target) {\r\n    const record = resolveRecord(accordionIdOrElement);\r\n    if (!record) return;\r\n    const ref = resolveItemRef(record, target);\r\n    if (!ref) return;\r\n    record.toggleItem(ref);\r\n  };\r\n\r\n  /**\r\n   * باز کردن همه آیتم‌ها (فقط اگر allowMultiple = true باشد)\r\n   */\r\n  window.Accordion.openAll = function (accordionIdOrElement) {\r\n    const record = resolveRecord(accordionIdOrElement);\r\n    if (!record) return;\r\n    const { allowMultiple, itemRefs, expandItem } = record;\r\n    if (!allowMultiple) {\r\n      // اگر اجازه‌ی چندتایی نداریم، فقط اولین آیتم را باز می‌کنیم\r\n      if (itemRefs[0]) expandItem(itemRefs[0]);\r\n      return;\r\n    }\r\n    itemRefs.forEach((ref) => expandItem(ref));\r\n  };\r\n\r\n  /**\r\n   * بستن همه آیتم‌ها (اگر allowToggle=false، یکی را باز نگه می‌داریم)\r\n   */\r\n  window.Accordion.closeAll = function (accordionIdOrElement) {\r\n    const record = resolveRecord(accordionIdOrElement);\r\n    if (!record) return;\r\n    const { allowToggle, itemRefs, collapseItem, isItemExpanded, expandItem } =\r\n      record;\r\n\r\n    if (!allowToggle) {\r\n      // حداقل یک آیتم باید باز بماند\r\n      let firstOpen = itemRefs.find((ref) => isItemExpanded(ref));\r\n      if (!firstOpen && itemRefs[0]) {\r\n        firstOpen = itemRefs[0];\r\n      }\r\n\r\n      // بقیه را می‌بندیم\r\n      itemRefs.forEach((ref) => {\r\n        if (ref === firstOpen) return;\r\n        collapseItem(ref);\r\n      });\r\n\r\n      // اگر firstOpen بسته بود، دوباره بازش می‌کنیم تا قانون حفظ شود\r\n      if (firstOpen && !isItemExpanded(firstOpen)) {\r\n        expandItem(firstOpen);\r\n      }\r\n      return;\r\n    }\r\n\r\n    itemRefs.forEach((ref) => collapseItem(ref));\r\n  };\r\n\r\n  /**\r\n   * init دستی برای آکاردئون‌هایی که بعداً به DOM اضافه می‌کنی\r\n   * @param {string | HTMLElement} rootOrSelector\r\n   */\r\n  window.Accordion.init = function (rootOrSelector) {\r\n    if (!rootOrSelector) return;\r\n    if (typeof rootOrSelector === \"string\") {\r\n      const nodes = document.querySelectorAll(rootOrSelector);\r\n      nodes.forEach((node, index) => {\r\n        if (!node.dataset.accordionId) {\r\n          node.dataset.accordionId = String(\r\n            ACCORDION_REGISTRY.size + index + 1\r\n          );\r\n        }\r\n        initAccordion(node);\r\n      });\r\n    } else if (rootOrSelector instanceof HTMLElement) {\r\n      if (!rootOrSelector.dataset.accordionId) {\r\n        rootOrSelector.dataset.accordionId = String(\r\n          ACCORDION_REGISTRY.size + 1\r\n        );\r\n      }\r\n      initAccordion(rootOrSelector);\r\n    }\r\n  };\r\n})();\r\n"]}