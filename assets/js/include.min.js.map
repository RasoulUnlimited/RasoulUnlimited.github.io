{"version":3,"file":"include.min.js","names":["async","includeHTML","callback","elements","document","querySelectorAll","length","err","console","error","TRUSTED_SCRIPT_PATHS","URL","window","location","href","origin","isScriptTrusted","src","url","some","path","pathname","startsWith","replace","fetches","el","file","getAttribute","removeAttribute","fetchPromise","fetch","then","resp","ok","Error","status","text","html","doc","DOMParser","parseFromString","body","firstChild","nodeName","sanitize","node","nodeType","Node","ELEMENT_NODE","Array","from","attributes","forEach","attr","name","toLowerCase","warn","tagName","includes","remove","getAttributeNS","removeAttributeNS","children","COMMENT_NODE","PROCESSING_INSTRUCTION_NODE","childNodes","innerHTML","appendChild","test","yearSpan","querySelector","textContent","String","Date","getFullYear","oldScript","newScript","createElement","safeAttributes","setAttribute","value","parentNode","replaceChild","catch","push","Promise","all","setActiveNavLink","normalize","current","link","classList","parentElement","linkPath","isActive","toggle","addEventListener","dispatchEvent","Event"],"sources":["include.js"],"mappings":"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","ignoreList":[],"sourcesContent":["// include.js - improved version\r\n(function () {\r\n  \"use strict\";\r\n\r\n  /**\r\n   * Injects external HTML fragments into elements with [data-include-html].\r\n   * - Returns a Promise so callers can chain on it.\r\n   * - Safely handles fetch errors.\r\n   * - Re-executes <script> tags inside included HTML (only from trusted sources).\r\n   * - Filters scripts from untrusted origins for security.\r\n   * @param {Function} [callback]\r\n   * @returns {Promise<void>}\r\n   */\r\n  async function includeHTML(callback) {\r\n    const elements = document.querySelectorAll(\"[data-include-html]\");\r\n    if (!elements.length) {\r\n      if (typeof callback === \"function\") {\r\n        try {\r\n          callback();\r\n        } catch (err) {\r\n          console.error(\"includeHTML callback error:\", err);\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Whitelist of trusted script paths that are allowed to be re-executed\r\n    const TRUSTED_SCRIPT_PATHS = [\r\n      \"/assets/js/\",\r\n      \"/includes/\",\r\n      new URL(window.location.href).origin + \"/assets/js/\",\r\n    ];\r\n\r\n    function isScriptTrusted(src) {\r\n      if (!src) return true; // inline scripts from trusted source are OK\r\n      try {\r\n        const url = new URL(src, window.location.origin);\r\n        // Only allow same-origin scripts from trusted directories\r\n        return url.origin === window.location.origin &&\r\n          TRUSTED_SCRIPT_PATHS.some((path) =>\r\n            url.pathname.startsWith(path.replace(window.location.origin, \"\"))\r\n          );\r\n      } catch {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    const fetches = [];\r\n\r\n    for (const el of elements) {\r\n      const file = el.getAttribute(\"data-include-html\");\r\n      if (!file) continue;\r\n\r\n      // Prevent double-include if function is called again\r\n      el.removeAttribute(\"data-include-html\");\r\n\r\n      const fetchPromise = fetch(file)\r\n        .then((resp) => {\r\n          if (!resp.ok) {\r\n            throw new Error(`HTTP ${resp.status} for ${file}`);\r\n          }\r\n          return resp.text();\r\n        })\r\n        .then((html) => {\r\n          // Use DOMParser to safely parse HTML\r\n          const parser = new DOMParser();\r\n          const doc = parser.parseFromString(html, \"text/html\");\r\n\r\n          // Check for parsing errors\r\n          if (\r\n            doc.body &&\r\n            doc.body.firstChild &&\r\n            doc.body.firstChild.nodeName === \"parsererror\"\r\n          ) {\r\n            throw new Error(`Failed to parse HTML for ${file}`);\r\n          }\r\n\r\n          // Sanitize by removing all event handlers and potentially dangerous elements\r\n          const sanitize = (node) => {\r\n            if (node.nodeType === Node.ELEMENT_NODE) {\r\n              // Remove all event handler attributes (on*)\r\n              const attributes = Array.from(node.attributes);\r\n              attributes.forEach((attr) => {\r\n                if (attr.name.toLowerCase().startsWith(\"on\")) {\r\n                  console.warn(\r\n                    `Removed event handler attribute: ${attr.name}`\r\n                  );\r\n                  node.removeAttribute(attr.name);\r\n                }\r\n              });\r\n\r\n              // Remove potentially dangerous elements/attributes\r\n              const tagName = node.tagName.toLowerCase();\r\n              \r\n              // Block object, embed, and form elements if they're not from trusted sources\r\n              if ([\"object\", \"embed\", \"form\"].includes(tagName)) {\r\n                console.warn(\r\n                  `Removed potentially dangerous element: ${tagName}`\r\n                );\r\n                node.remove();\r\n                return;\r\n              }\r\n\r\n              // For SVG and other elements, remove suspicious attributes\r\n              if (\r\n                tagName === \"svg\" ||\r\n                tagName === \"use\" ||\r\n                tagName === \"image\"\r\n              ) {\r\n                const href = node.getAttribute(\"href\") ||\r\n                  node.getAttributeNS(\"http://www.w3.org/1999/xlink\", \"href\");\r\n                if (href && href.toLowerCase().startsWith(\"javascript:\")) {\r\n                  node.removeAttribute(\"href\");\r\n                  node.removeAttributeNS(\r\n                    \"http://www.w3.org/1999/xlink\",\r\n                    \"href\"\r\n                  );\r\n                  console.warn(`Removed javascript: URI from ${tagName}`);\r\n                }\r\n              }\r\n\r\n              // Recursively sanitize child nodes\r\n              Array.from(node.children).forEach(sanitize);\r\n            } else if (\r\n              node.nodeType === Node.COMMENT_NODE ||\r\n              node.nodeType === Node.PROCESSING_INSTRUCTION_NODE\r\n            ) {\r\n              // Remove comments and processing instructions\r\n              node.remove();\r\n            }\r\n          };\r\n\r\n          // Sanitize all nodes in the document\r\n          const bodyChildren = Array.from(doc.body.childNodes);\r\n          bodyChildren.forEach(sanitize);\r\n\r\n          // Clear existing content (e.g. \"Loading...\") before appending\r\n          el.innerHTML = \"\";\r\n\r\n          // Safely append parsed content\r\n          while (doc.body && doc.body.firstChild) {\r\n            el.appendChild(doc.body.firstChild);\r\n          }\r\n\r\n          // Special-case: footer year autofill\r\n          if (/footer\\.html$/i.test(file)) {\r\n            const yearSpan =\r\n              el.querySelector(\"#footer-year\") ||\r\n              el.querySelector(\"#current-year\");\r\n            if (yearSpan) {\r\n              yearSpan.textContent = String(new Date().getFullYear());\r\n            }\r\n          }\r\n\r\n          // Re-execute any <script> tags inside included HTML (with security validation)\r\n          const scripts = el.querySelectorAll(\"script\");\r\n          scripts.forEach((oldScript) => {\r\n            // Security check: only re-execute trusted scripts\r\n            if (oldScript.src && !isScriptTrusted(oldScript.src)) {\r\n              console.warn(\r\n                \"Blocked untrusted external script in included HTML:\",\r\n                oldScript.src\r\n              );\r\n              oldScript.remove();\r\n              return;\r\n            }\r\n\r\n            const newScript = document.createElement(\"script\");\r\n\r\n            // Copy only safe attributes\r\n            const safeAttributes = [\"type\", \"async\", \"defer\", \"charset\"];\r\n            for (const attr of oldScript.attributes) {\r\n              if (safeAttributes.includes(attr.name)) {\r\n                newScript.setAttribute(attr.name, attr.value);\r\n              }\r\n            }\r\n\r\n            if (oldScript.src) {\r\n              // External script (already validated as trusted above)\r\n              newScript.src = oldScript.src;\r\n            } else {\r\n              // Inline script - copy text content directly\r\n              newScript.textContent = oldScript.textContent;\r\n            }\r\n\r\n            oldScript.parentNode.replaceChild(newScript, oldScript);\r\n          });\r\n        })\r\n        .catch((err) => {\r\n          console.error(\"Include error for\", file, err);\r\n        });\r\n\r\n      fetches.push(fetchPromise);\r\n    }\r\n\r\n    await Promise.all(fetches);\r\n\r\n    if (typeof callback === \"function\") {\r\n      try {\r\n        callback();\r\n      } catch (err) {\r\n        console.error(\"includeHTML callback error:\", err);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Marks current page link as active in navbar.\r\n   * Handles:\r\n   * - /, /index.html â†’ /\r\n   * - trailing slashes\r\n   * - ignores hash/query, mailto, and pure hash links\r\n   */\r\n  function setActiveNavLink() {\r\n    const normalize = (path) =>\r\n      path\r\n        .replace(/\\/index\\.html$/i, \"/\")\r\n        .replace(/\\/+$/, \"/\") || \"/\";\r\n\r\n    const current = normalize(window.location.pathname);\r\n\r\n    document.querySelectorAll(\".navbar nav a\").forEach((link) => {\r\n      const href = link.getAttribute(\"href\") || \"\";\r\n\r\n      // Skip anchors / mailto / javascript: links\r\n      if (\r\n        href.startsWith(\"#\") ||\r\n        href.startsWith(\"mailto:\") ||\r\n        href.startsWith(\"javascript:\")\r\n      ) {\r\n        link.classList.remove(\"active\");\r\n        link.removeAttribute(\"aria-current\");\r\n        if (link.parentElement && link.parentElement.tagName === \"LI\") {\r\n          link.parentElement.classList.remove(\"active\");\r\n        }\r\n        return;\r\n      }\r\n\r\n      let linkPath;\r\n      try {\r\n        const url = new URL(href, window.location.origin);\r\n        linkPath = normalize(url.pathname);\r\n      } catch (err) {\r\n        // If URL constructor fails for some reason, fallback to current\r\n        linkPath = \"\";\r\n      }\r\n\r\n      const isActive = linkPath === current;\r\n      link.classList.toggle(\"active\", isActive);\r\n\r\n      if (isActive) {\r\n        link.setAttribute(\"aria-current\", \"page\");\r\n      } else {\r\n        link.removeAttribute(\"aria-current\");\r\n      }\r\n\r\n      if (link.parentElement && link.parentElement.tagName === \"LI\") {\r\n        link.parentElement.classList.toggle(\"active\", isActive);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Boot\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    includeHTML(() => {\r\n      setActiveNavLink();\r\n      // Keep your original contract: fire after includes + nav activation\r\n      document.dispatchEvent(new Event(\"includesLoaded\"));\r\n    });\r\n  });\r\n\r\n  // Optionally expose includeHTML globally if you want to re-run it manually\r\n  window.includeHTML = includeHTML;\r\n})();\r\n"]}