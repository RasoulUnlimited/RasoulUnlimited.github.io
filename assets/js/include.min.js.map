{"version":3,"file":"include.min.js","names":["ORIGIN","window","location","origin","async","includeHTML","callback","elements","document","querySelectorAll","length","err","console","error","TRUSTED_SCRIPT_PATH_PREFIXES","isScriptTrusted","src","url","URL","some","prefix","pathname","startsWith","cspSourceScript","querySelector","globalNonce","nonce","fetches","el","file","getAttribute","e","removeAttribute","fetchPromise","fetch","then","resp","ok","Error","status","text","html","doc","DOMParser","parseFromString","sanitize","node","nodeType","Node","ELEMENT_NODE","Array","from","attributes","forEach","attr","name","toLowerCase","warn","tagName","includes","remove","attrName","val","getAttributeNS","trim","removeAttributeNS","childNodes","COMMENT_NODE","PROCESSING_INSTRUCTION_NODE","body","innerHTML","firstChild","appendChild","test","yearSpan","textContent","String","Date","getFullYear","oldScript","newScript","createElement","safeAttributes","setAttribute","value","parentNode","replaceChild","catch","push","Promise","all","addEventListener","normalize","path","replace","current","link","href","classList","parentElement","linkPath","isActive","toggle","setActiveNavLink","dispatchEvent","Event"],"sources":["include.js"],"mappings":"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","ignoreList":[],"sourcesContent":["// include.js - improved + refined version\r\n(function () {\r\n  \"use strict\";\r\n\r\n  const ORIGIN = window.location.origin;\r\n\r\n  /**\r\n   * Injects external HTML fragments into elements with [data-include-html].\r\n   * - Returns a Promise so callers can chain on it.\r\n   * - Safely handles fetch errors.\r\n   * - Re-executes <script> tags inside included HTML (only from trusted sources).\r\n   * - Filters scripts from untrusted origins for security.\r\n   * @param {Function} [callback]\r\n   * @returns {Promise<void>}\r\n   */\r\n  async function includeHTML(callback) {\r\n    const elements = document.querySelectorAll(\"[data-include-html]\");\r\n    if (!elements.length) {\r\n      if (typeof callback === \"function\") {\r\n        try {\r\n          callback();\r\n        } catch (err) {\r\n          console.error(\"includeHTML callback error:\", err);\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Whitelist of trusted script path prefixes (same-origin)\r\n    const TRUSTED_SCRIPT_PATH_PREFIXES = [\r\n      \"/assets/js/\",\r\n      \"/includes/\",\r\n    ];\r\n\r\n    function isScriptTrusted(src) {\r\n      // Inline scripts (no src) are considered trusted for this site setup\r\n      // If in future you include untrusted/user content, tighten this rule.\r\n      if (!src) { return true; }\r\n\r\n      try {\r\n        const url = new URL(src, ORIGIN);\r\n        if (url.origin !== ORIGIN) {\r\n          return false;\r\n        }\r\n        return TRUSTED_SCRIPT_PATH_PREFIXES.some((prefix) =>\r\n          url.pathname.startsWith(prefix)\r\n        );\r\n      } catch {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // Optional CSP nonce propagation (if you decide to use it later)\r\n    // Example: <script data-csp-nonce nonce=\"...\"></script> in main HTML\r\n    const cspSourceScript = document.querySelector(\"script[data-csp-nonce]\");\r\n    const globalNonce = cspSourceScript?.nonce || null;\r\n\r\n    const fetches = [];\r\n\r\n    for (const el of elements) {\r\n      const file = el.getAttribute(\"data-include-html\");\r\n      if (!file) { continue; }\r\n\r\n      // Security check: Ensure file is same-origin\r\n      try {\r\n        const fileUrl = new URL(file, ORIGIN);\r\n        if (fileUrl.origin !== ORIGIN) {\r\n          console.error(\"Blocked cross-origin include:\", file);\r\n          continue;\r\n        }\r\n      } catch (e) {\r\n        console.error(\"Invalid include URL:\", file);\r\n        continue;\r\n      }\r\n\r\n      // Prevent double-include if function is called again\r\n      el.removeAttribute(\"data-include-html\");\r\n\r\n      const fetchPromise = fetch(file)\r\n        .then((resp) => {\r\n          if (!resp.ok) {\r\n            throw new Error(\"HTTP \" + resp.status + \" for \" + file);\r\n          }\r\n          return resp.text();\r\n        })\r\n        .then((html) => {\r\n          // Use DOMParser to safely parse HTML\r\n          const parser = new DOMParser();\r\n          const doc = parser.parseFromString(html, \"text/html\");\r\n\r\n          // Check for parsing errors (more robust than body.firstChild check)\r\n          if (doc.querySelector(\"parsererror\")) {\r\n            throw new Error(\"Failed to parse HTML for \" + file);\r\n          }\r\n\r\n          // Sanitize by removing event handlers, comments, and dangerous elements\r\n          const sanitize = (node) => {\r\n            if (!node) { return; }\r\n\r\n            if (node.nodeType === Node.ELEMENT_NODE) {\r\n              // Remove all event handler attributes (on*)\r\n              const attributes = Array.from(node.attributes);\r\n              attributes.forEach((attr) => {\r\n                if (attr.name.toLowerCase().startsWith(\"on\")) {\r\n                  console.warn(\"Removed event handler attribute:\", attr.name);\r\n                  node.removeAttribute(attr.name);\r\n                }\r\n              });\r\n\r\n              const tagName = node.tagName.toLowerCase();\r\n\r\n              // Block object, embed, and iframe elements completely\r\n              if ([\"object\", \"embed\", \"iframe\"].includes(tagName)) {\r\n                console.warn(\"Removed potentially dangerous element:\", tagName);\r\n                node.remove();\r\n                return;\r\n              }\r\n\r\n              // For specific elements, strip javascript: URLs from href/action/etc.\r\n              if (\r\n                tagName === \"svg\" ||\r\n                tagName === \"use\" ||\r\n                tagName === \"image\" ||\r\n                tagName === \"a\" ||\r\n                tagName === \"area\" ||\r\n                tagName === \"form\" ||\r\n                tagName === \"button\" ||\r\n                tagName === \"input\"\r\n              ) {\r\n                const attributesToCheck = [\r\n                  \"href\",\r\n                  \"xlink:href\",\r\n                  \"action\",\r\n                  \"formaction\",\r\n                ];\r\n\r\n                attributesToCheck.forEach((attrName) => {\r\n                  let val = node.getAttribute(attrName);\r\n\r\n                  // Special-case xlink:href\r\n                  if (!val && attrName === \"xlink:href\") {\r\n                    val = node.getAttributeNS(\r\n                      \"http://www.w3.org/1999/xlink\",\r\n                      \"href\"\r\n                    );\r\n                  }\r\n\r\n                  // eslint-disable-next-line no-script-url\r\n                  if (val && val.toLowerCase().trim().startsWith(\"javascript:\")) {\r\n                    node.removeAttribute(attrName);\r\n                    if (attrName === \"xlink:href\") {\r\n                      node.removeAttributeNS(\r\n                        \"http://www.w3.org/1999/xlink\",\r\n                        \"href\"\r\n                      );\r\n                    }\r\n                    console.warn(\r\n                      \"Removed javascript: URI from\",\r\n                      tagName,\r\n                      \"attribute\",\r\n                      attrName\r\n                    );\r\n                  }\r\n                });\r\n              }\r\n\r\n              // Recursively sanitize all child nodes (not just elements)\r\n              Array.from(node.childNodes).forEach(sanitize);\r\n            } else if (\r\n              node.nodeType === Node.COMMENT_NODE ||\r\n              node.nodeType === Node.PROCESSING_INSTRUCTION_NODE\r\n            ) {\r\n              // Remove comments and processing instructions\r\n              node.remove();\r\n            }\r\n          };\r\n\r\n          // Sanitize all nodes in the document body\r\n          const bodyChildren = Array.from(doc.body.childNodes);\r\n          bodyChildren.forEach(sanitize);\r\n\r\n          // Clear existing content (e.g. \"Loading...\") before appending\r\n          el.innerHTML = \"\";\r\n\r\n          // Safely append parsed content\r\n          while (doc.body && doc.body.firstChild) {\r\n            el.appendChild(doc.body.firstChild);\r\n          }\r\n\r\n          // Special-case: footer year autofill\r\n          if (/footer\\.html$/i.test(file)) {\r\n            const yearSpan =\r\n              el.querySelector(\"#footer-year\") ||\r\n              el.querySelector(\"#current-year\");\r\n            if (yearSpan) {\r\n              yearSpan.textContent = String(new Date().getFullYear());\r\n            }\r\n          }\r\n\r\n          // Re-execute any <script> tags inside included HTML (with security validation)\r\n          const scripts = el.querySelectorAll(\"script\");\r\n          scripts.forEach((oldScript) => {\r\n            // Security check: only re-execute trusted scripts\r\n            if (oldScript.src && !isScriptTrusted(oldScript.src)) {\r\n              console.warn(\r\n                \"Blocked untrusted external script in included HTML:\",\r\n                oldScript.src\r\n              );\r\n              oldScript.remove();\r\n              return;\r\n            }\r\n\r\n            const newScript = document.createElement(\"script\");\r\n\r\n            // Copy safe attributes including id, class, and data-*\r\n            const safeAttributes = [\r\n              \"type\",\r\n              \"async\",\r\n              \"defer\",\r\n              \"charset\",\r\n              \"id\",\r\n              \"class\",\r\n            ];\r\n\r\n            for (const attr of oldScript.attributes) {\r\n              if (\r\n                safeAttributes.includes(attr.name) ||\r\n                attr.name.startsWith(\"data-\")\r\n              ) {\r\n                newScript.setAttribute(attr.name, attr.value);\r\n              }\r\n            }\r\n\r\n            // Optional: propagate CSP nonce if you use it\r\n            if (globalNonce) {\r\n              newScript.nonce = globalNonce;\r\n            }\r\n\r\n            if (oldScript.src) {\r\n              // External script (already validated as trusted above)\r\n              newScript.src = oldScript.src;\r\n            } else {\r\n              // Inline script - copy text content directly\r\n              newScript.textContent = oldScript.textContent;\r\n            }\r\n\r\n            oldScript.parentNode.replaceChild(newScript, oldScript);\r\n          });\r\n        })\r\n        .catch((err) => {\r\n          console.error(\"Include error for\", file, err);\r\n        });\r\n\r\n      fetches.push(fetchPromise);\r\n    }\r\n\r\n    await Promise.all(fetches);\r\n\r\n    if (typeof callback === \"function\") {\r\n      try {\r\n        callback();\r\n      } catch (err) {\r\n        console.error(\"includeHTML callback error:\", err);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Marks current page link as active in navbar.\r\n   * Handles:\r\n   * - /, /index.html â†’ /\r\n   * - trailing slashes\r\n   * - ignores hash/query, mailto, and pure hash links\r\n   */\r\n  function setActiveNavLink() {\r\n    const normalize = (path) =>\r\n      (path || \"/\")\r\n        .replace(/\\/index\\.html$/i, \"/\")\r\n        .replace(/\\/+$/, \"/\") || \"/\";\r\n\r\n    const current = normalize(window.location.pathname);\r\n\r\n    document.querySelectorAll(\".navbar nav a\").forEach((link) => {\r\n      const href = link.getAttribute(\"href\") || \"\";\r\n\r\n      // Skip anchors / mailto / javascript: links\r\n      if (\r\n        href.startsWith(\"#\") ||\r\n        href.startsWith(\"mailto:\") ||\r\n        // eslint-disable-next-line no-script-url\r\n        href.startsWith(\"javascript:\")\r\n      ) {\r\n        link.classList.remove(\"active\");\r\n        link.removeAttribute(\"aria-current\");\r\n        if (link.parentElement && link.parentElement.tagName === \"LI\") {\r\n          link.parentElement.classList.remove(\"active\");\r\n        }\r\n        return;\r\n      }\r\n\r\n      let linkPath = \"\";\r\n      try {\r\n        const url = new URL(href, ORIGIN);\r\n        linkPath = normalize(url.pathname);\r\n      } catch (err) {\r\n        // If URL constructor fails for some reason, leave link inactive\r\n        linkPath = \"\";\r\n      }\r\n\r\n      const isActive = linkPath === current;\r\n      link.classList.toggle(\"active\", isActive);\r\n\r\n      if (isActive) {\r\n        link.setAttribute(\"aria-current\", \"page\");\r\n      } else {\r\n        link.removeAttribute(\"aria-current\");\r\n      }\r\n\r\n      if (link.parentElement && link.parentElement.tagName === \"LI\") {\r\n        link.parentElement.classList.toggle(\"active\", isActive);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Boot\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    includeHTML(() => {\r\n      setActiveNavLink();\r\n      // Keep your original contract: fire after includes + nav activation\r\n      document.dispatchEvent(new Event(\"includesLoaded\"));\r\n    });\r\n  });\r\n\r\n  // Optionally expose includeHTML globally if you want to re-run it manually\r\n  window.includeHTML = includeHTML;\r\n})();\r\n"]}