{"version":3,"file":"include.min.js","names":["async","includeHTML","callback","elements","document","querySelectorAll","length","err","console","error","TRUSTED_SCRIPT_PATHS","URL","window","location","href","origin","isScriptTrusted","src","url","some","path","pathname","startsWith","replace","fetches","el","file","getAttribute","e","removeAttribute","fetchPromise","fetch","then","resp","ok","Error","status","text","html","doc","DOMParser","parseFromString","body","firstChild","nodeName","sanitize","node","nodeType","Node","ELEMENT_NODE","Array","from","attributes","forEach","attr","name","toLowerCase","warn","tagName","includes","remove","attrName","val","getAttributeNS","trim","removeAttributeNS","children","COMMENT_NODE","PROCESSING_INSTRUCTION_NODE","childNodes","innerHTML","appendChild","test","yearSpan","querySelector","textContent","String","Date","getFullYear","oldScript","newScript","createElement","safeAttributes","setAttribute","value","parentNode","replaceChild","catch","push","Promise","all","addEventListener","normalize","current","link","classList","parentElement","linkPath","isActive","toggle","setActiveNavLink","dispatchEvent","Event"],"sources":["include.js"],"mappings":"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","ignoreList":[],"sourcesContent":["// include.js - improved version\r\n(function () {\r\n  \"use strict\";\r\n\r\n  /**\r\n   * Injects external HTML fragments into elements with [data-include-html].\r\n   * - Returns a Promise so callers can chain on it.\r\n   * - Safely handles fetch errors.\r\n   * - Re-executes <script> tags inside included HTML (only from trusted sources).\r\n   * - Filters scripts from untrusted origins for security.\r\n   * @param {Function} [callback]\r\n   * @returns {Promise<void>}\r\n   */\r\n  async function includeHTML(callback) {\r\n    const elements = document.querySelectorAll(\"[data-include-html]\");\r\n    if (!elements.length) {\r\n      if (typeof callback === \"function\") {\r\n        try {\r\n          callback();\r\n        } catch (err) {\r\n          console.error(\"includeHTML callback error:\", err);\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Whitelist of trusted script paths that are allowed to be re-executed\r\n    const TRUSTED_SCRIPT_PATHS = [\r\n      \"/assets/js/\",\r\n      \"/includes/\",\r\n      new URL(window.location.href).origin + \"/assets/js/\",\r\n    ];\r\n\r\n    function isScriptTrusted(src) {\r\n      if (!src) {return true;} // inline scripts from trusted source are OK\r\n      try {\r\n        const url = new URL(src, window.location.origin);\r\n        // Only allow same-origin scripts from trusted directories\r\n        return url.origin === window.location.origin &&\r\n          TRUSTED_SCRIPT_PATHS.some((path) =>\r\n            url.pathname.startsWith(path.replace(window.location.origin, \"\"))\r\n          );\r\n      } catch {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    const fetches = [];\r\n\r\n    for (const el of elements) {\r\n      const file = el.getAttribute(\"data-include-html\");\r\n      if (!file) {continue;}\r\n\r\n      // Security check: Ensure file is same-origin\r\n      try {\r\n        const fileUrl = new URL(file, window.location.origin);\r\n        if (fileUrl.origin !== window.location.origin) {\r\n          console.error(`Blocked cross-origin include: ${file}`);\r\n          continue;\r\n        }\r\n      } catch (e) {\r\n        console.error(`Invalid include URL: ${file}`);\r\n        continue;\r\n      }\r\n\r\n      // Prevent double-include if function is called again\r\n      el.removeAttribute(\"data-include-html\");\r\n\r\n      const fetchPromise = fetch(file)\r\n        .then((resp) => {\r\n          if (!resp.ok) {\r\n            throw new Error(`HTTP ${resp.status} for ${file}`);\r\n          }\r\n          return resp.text();\r\n        })\r\n        .then((html) => {\r\n          // Use DOMParser to safely parse HTML\r\n          const parser = new DOMParser();\r\n          const doc = parser.parseFromString(html, \"text/html\");\r\n\r\n          // Check for parsing errors\r\n          if (\r\n            doc.body &&\r\n            doc.body.firstChild &&\r\n            doc.body.firstChild.nodeName === \"parsererror\"\r\n          ) {\r\n            throw new Error(`Failed to parse HTML for ${file}`);\r\n          }\r\n\r\n          // Sanitize by removing all event handlers and potentially dangerous elements\r\n          const sanitize = (node) => {\r\n            if (node.nodeType === Node.ELEMENT_NODE) {\r\n              // Remove all event handler attributes (on*)\r\n              const attributes = Array.from(node.attributes);\r\n              attributes.forEach((attr) => {\r\n                if (attr.name.toLowerCase().startsWith(\"on\")) {\r\n                  console.warn(\r\n                    `Removed event handler attribute: ${attr.name}`\r\n                  );\r\n                  node.removeAttribute(attr.name);\r\n                }\r\n              });\r\n\r\n              // Remove potentially dangerous elements/attributes\r\n              const tagName = node.tagName.toLowerCase();\r\n\r\n              // Block object, embed, and iframe elements\r\n              if ([\"object\", \"embed\", \"iframe\"].includes(tagName)) {\r\n                console.warn(\r\n                  `Removed potentially dangerous element: ${tagName}`\r\n                );\r\n                node.remove();\r\n                return;\r\n              }\r\n\r\n              // For SVG and other elements, remove suspicious attributes\r\n              if (\r\n                tagName === \"svg\" ||\r\n                tagName === \"use\" ||\r\n                tagName === \"image\" ||\r\n                tagName === \"a\" ||\r\n                tagName === \"area\" ||\r\n                tagName === \"form\" ||\r\n                tagName === \"button\" ||\r\n                tagName === \"input\"\r\n              ) {\r\n                const attributesToCheck = [\"href\", \"xlink:href\", \"action\", \"formaction\"];\r\n                attributesToCheck.forEach(attrName => {\r\n                  const val = node.getAttribute(attrName) || \r\n                              node.getAttributeNS(\"http://www.w3.org/1999/xlink\", \"href\");\r\n                  \r\n                  // eslint-disable-next-line no-script-url\r\n                  if (val && val.toLowerCase().trim().startsWith(\"javascript:\")) {\r\n                    node.removeAttribute(attrName);\r\n                    if (attrName === \"xlink:href\") {\r\n                       node.removeAttributeNS(\"http://www.w3.org/1999/xlink\", \"href\");\r\n                    }\r\n                    console.warn(`Removed javascript: URI from ${tagName} attribute ${attrName}`);\r\n                  }\r\n                });\r\n              }\r\n\r\n              // Recursively sanitize child nodes\r\n              Array.from(node.children).forEach(sanitize);\r\n            } else if (\r\n              node.nodeType === Node.COMMENT_NODE ||\r\n              node.nodeType === Node.PROCESSING_INSTRUCTION_NODE\r\n            ) {\r\n              // Remove comments and processing instructions\r\n              node.remove();\r\n            }\r\n          };\r\n\r\n          // Sanitize all nodes in the document\r\n          const bodyChildren = Array.from(doc.body.childNodes);\r\n          bodyChildren.forEach(sanitize);\r\n\r\n          // Clear existing content (e.g. \"Loading...\") before appending\r\n          el.innerHTML = \"\";\r\n\r\n          // Safely append parsed content\r\n          while (doc.body && doc.body.firstChild) {\r\n            el.appendChild(doc.body.firstChild);\r\n          }\r\n\r\n          // Special-case: footer year autofill\r\n          if (/footer\\.html$/i.test(file)) {\r\n            const yearSpan =\r\n              el.querySelector(\"#footer-year\") ||\r\n              el.querySelector(\"#current-year\");\r\n            if (yearSpan) {\r\n              yearSpan.textContent = String(new Date().getFullYear());\r\n            }\r\n          }\r\n\r\n          // Re-execute any <script> tags inside included HTML (with security validation)\r\n          const scripts = el.querySelectorAll(\"script\");\r\n          scripts.forEach((oldScript) => {\r\n            // Security check: only re-execute trusted scripts\r\n            if (oldScript.src && !isScriptTrusted(oldScript.src)) {\r\n              console.warn(\r\n                \"Blocked untrusted external script in included HTML:\",\r\n                oldScript.src\r\n              );\r\n              oldScript.remove();\r\n              return;\r\n            }\r\n\r\n            const newScript = document.createElement(\"script\");\r\n\r\n            // Copy safe attributes including id, class, and data-*\r\n            const safeAttributes = [\"type\", \"async\", \"defer\", \"charset\", \"id\", \"class\"];\r\n            for (const attr of oldScript.attributes) {\r\n              if (safeAttributes.includes(attr.name) || attr.name.startsWith(\"data-\")) {\r\n                newScript.setAttribute(attr.name, attr.value);\r\n              }\r\n            }\r\n\r\n            if (oldScript.src) {\r\n              // External script (already validated as trusted above)\r\n              newScript.src = oldScript.src;\r\n            } else {\r\n              // Inline script - copy text content directly\r\n              newScript.textContent = oldScript.textContent;\r\n            }\r\n\r\n            oldScript.parentNode.replaceChild(newScript, oldScript);\r\n          });\r\n        })\r\n        .catch((err) => {\r\n          console.error(\"Include error for\", file, err);\r\n        });\r\n\r\n      fetches.push(fetchPromise);\r\n    }\r\n\r\n    await Promise.all(fetches);\r\n\r\n    // Recursively process any new includes that were injected\r\n    if (document.querySelectorAll(\"[data-include-html]\").length > 0) {\r\n      await includeHTML(callback);\r\n      return;\r\n    }\r\n\r\n    if (typeof callback === \"function\") {\r\n      try {\r\n        callback();\r\n      } catch (err) {\r\n        console.error(\"includeHTML callback error:\", err);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Marks current page link as active in navbar.\r\n   * Handles:\r\n   * - /, /index.html â†’ /\r\n   * - trailing slashes\r\n   * - ignores hash/query, mailto, and pure hash links\r\n   */\r\n  function setActiveNavLink() {\r\n    const normalize = (path) =>\r\n      path\r\n        .replace(/\\/index\\.html$/i, \"/\")\r\n        .replace(/\\/+$/, \"/\") || \"/\";\r\n\r\n    const current = normalize(window.location.pathname);\r\n\r\n    document.querySelectorAll(\".navbar nav a\").forEach((link) => {\r\n      const href = link.getAttribute(\"href\") || \"\";\r\n\r\n      // Skip anchors / mailto / javascript: links\r\n      if (\r\n        href.startsWith(\"#\") ||\r\n        href.startsWith(\"mailto:\") ||\r\n        // eslint-disable-next-line no-script-url\r\n        href.startsWith(\"javascript:\")\r\n      ) {\r\n        link.classList.remove(\"active\");\r\n        link.removeAttribute(\"aria-current\");\r\n        if (link.parentElement && link.parentElement.tagName === \"LI\") {\r\n          link.parentElement.classList.remove(\"active\");\r\n        }\r\n        return;\r\n      }\r\n\r\n      let linkPath;\r\n      try {\r\n        const url = new URL(href, window.location.origin);\r\n        linkPath = normalize(url.pathname);\r\n      } catch (err) {\r\n        // If URL constructor fails for some reason, fallback to current\r\n        linkPath = \"\";\r\n      }\r\n\r\n      const isActive = linkPath === current;\r\n      link.classList.toggle(\"active\", isActive);\r\n\r\n      if (isActive) {\r\n        link.setAttribute(\"aria-current\", \"page\");\r\n      } else {\r\n        link.removeAttribute(\"aria-current\");\r\n      }\r\n\r\n      if (link.parentElement && link.parentElement.tagName === \"LI\") {\r\n        link.parentElement.classList.toggle(\"active\", isActive);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Boot\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    includeHTML(() => {\r\n      setActiveNavLink();\r\n      // Keep your original contract: fire after includes + nav activation\r\n      document.dispatchEvent(new Event(\"includesLoaded\"));\r\n    });\r\n  });\r\n\r\n  // Optionally expose includeHTML globally if you want to re-run it manually\r\n  window.includeHTML = includeHTML;\r\n})();\r\n"]}