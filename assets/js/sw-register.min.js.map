{"version":3,"file":"sw-register.min.js","names":["navigator","window","isSecureContext","console","warn","docLang","document","documentElement","getAttribute","toLowerCase","navLang","language","indexOf","activeRegistration","updateCheckTimer","readyNotified","updateNotified","safeToast","message","options","createToast","settings","kind","duration","notifyReady","id","notifyUpdate","attachInstalledListener","worker","addEventListener","onStateChange","state","serviceWorker","controller","removeEventListener","safeUpdateCheck","reason","onLine","update","catch","err","handleRegistration","reg","waiting","installing","ready","then","setInterval","visibilityState","clearInterval","registerServiceWorker","register","scope","error","readyState","once"],"sources":["sw-register.js"],"mappings":"CAGA,WACE,aAEA,KAAM,kBAAmBA,WACvB,OAGF,IAAKC,OAAOC,gBAEV,YADAC,QAAQC,KAAK,iDAIf,MAGMC,GAFOC,SAASC,gBAEAC,aAAa,SAAW,IAAIC,cAC5CC,GAAWV,UAAUW,UAAY,IAAIF,eAC9BJ,GAAWK,GACNE,QAAQ,MAE1B,IAAIC,EAAqB,KACrBC,EAAmB,KACnBC,GAAgB,EAChBC,GAAiB,EAErB,SAASC,EAAUC,EAASC,EAAU,CAAC,GACrC,IAAKD,GAAyC,mBAAvBjB,OAAOmB,YAC5B,OAEF,MAAMC,EAAW,CACfC,KAAM,OACNC,SAAU,QACPJ,GAELlB,OAAOmB,YAAYF,EAASG,EAC9B,CAEA,SAASG,IACHT,IAGJA,GAAgB,EAChBE,EAAiB,0BAAuD,CACtEQ,GAAI,iBACJH,KAAM,UACNC,SAAU,OAEd,CAEA,SAASG,IACHV,IAGJA,GAAiB,EACjBC,EAEM,iDAEJ,CACEQ,GAAI,kBACJH,KAAM,OACNC,SAAU,OAGhB,CAEA,SAASI,EAAwBC,GAC1BA,GAkBLA,EAAOC,iBAAiB,cAdxB,SAASC,IACc,cAAjBF,EAAOG,QAIP/B,UAAUgC,cAAcC,WAC1BP,IAEAF,IAGFI,EAAOM,oBAAoB,cAAeJ,GAC5C,EAGF,CAEA,SAASK,EAAgBC,GAClBvB,GAAuBb,UAAUqC,QAItCxB,EAAmByB,SAASC,MAAOC,IACjCrC,QAAQC,KAAK,uCAAyCgC,EAAS,KAAMI,IAEzE,CA6BA,SAASC,EAAmBC,GACrBA,IAIL7B,EAAqB6B,EAEjBA,EAAIC,SACNjB,IAGFC,EAAwBe,EAAIE,YAEQ,mBAAzBF,EAAIb,kBACba,EAAIb,iBAAiB,cAAe,KAClCF,EAAwBe,EAAIE,cAI3B5C,UAAUgC,cAAcC,YAC3BjC,UAAUgC,cAAca,MACrBC,KAAK,KACA9C,UAAUgC,cAAcC,YAC1BT,MAGHe,MAAM,QAKXvC,UAAUgC,cAAcH,iBAAiB,mBAAoB,KAC3Db,GAAiB,IA1DfF,IAIJA,EAAmBb,OAAO8C,YAAY,KACpCZ,EAAgB,aA5Fa,MA+F/B7B,SAASuB,iBAAiB,mBAAoB,KACX,YAA7BvB,SAAS0C,iBACXb,EAAgB,gBAIpBlC,OAAO4B,iBAAiB,SAAU,KAChCM,EAAgB,YAGlBlC,OAAO4B,iBAAiB,eAAgB,KAClCf,IACFb,OAAOgD,cAAcnC,GACrBA,EAAmB,SAyCvBqB,EAAgB,iBAClB,CAEA,SAASe,IACPlD,UAAUgC,cACPmB,SAAS,SAAU,CAAEC,MAAO,MAC5BN,KAAKL,GACLF,MAAOC,IACNrC,QAAQkD,MAAM,sCAAuCb,IAE3D,CAE4B,aAAxBlC,SAASgD,WACXJ,IAEAjD,OAAO4B,iBAAiB,OAAQqB,EAAuB,CAAEK,MAAM,GAElE,CAlLD","ignoreList":[],"sourcesContent":["// js/sw-register.js\n// Robust Service Worker registration with periodic update checks.\n\n(function () {\n  \"use strict\";\n\n  if (!(\"serviceWorker\" in navigator)) {\n    return;\n  }\n\n  if (!window.isSecureContext) {\n    console.warn(\"Service workers require HTTPS (or localhost).\");\n    return;\n  }\n\n  const UPDATE_CHECK_INTERVAL_MS = 60 * 60 * 1000;\n  const root = document.documentElement;\n\n  const docLang = (root.getAttribute(\"lang\") || \"\").toLowerCase();\n  const navLang = (navigator.language || \"\").toLowerCase();\n  const lang = docLang || navLang;\n  const isFa = lang.indexOf(\"fa\") === 0;\n\n  let activeRegistration = null;\n  let updateCheckTimer = null;\n  let readyNotified = false;\n  let updateNotified = false;\n\n  function safeToast(message, options = {}) {\n    if (!message || typeof window.createToast !== \"function\") {\n      return;\n    }\n    const settings = {\n      kind: \"info\",\n      duration: 2600,\n      ...options,\n    };\n    window.createToast(message, settings);\n  }\n\n  function notifyReady() {\n    if (readyNotified) {\n      return;\n    }\n    readyNotified = true;\n    safeToast(isFa ? \"Offline support enabled\" : \"Offline support enabled\", {\n      id: \"sw-ready-toast\",\n      kind: \"success\",\n      duration: 2200,\n    });\n  }\n\n  function notifyUpdate() {\n    if (updateNotified) {\n      return;\n    }\n    updateNotified = true;\n    safeToast(\n      isFa\n        ? \"A new version is available. Refresh to update.\"\n        : \"A new version is available. Refresh to update.\",\n      {\n        id: \"sw-update-toast\",\n        kind: \"info\",\n        duration: 3200,\n      }\n    );\n  }\n\n  function attachInstalledListener(worker) {\n    if (!worker) {\n      return;\n    }\n\n    function onStateChange() {\n      if (worker.state !== \"installed\") {\n        return;\n      }\n\n      if (navigator.serviceWorker.controller) {\n        notifyUpdate();\n      } else {\n        notifyReady();\n      }\n\n      worker.removeEventListener(\"statechange\", onStateChange);\n    }\n\n    worker.addEventListener(\"statechange\", onStateChange);\n  }\n\n  function safeUpdateCheck(reason) {\n    if (!activeRegistration || !navigator.onLine) {\n      return;\n    }\n\n    activeRegistration.update().catch((err) => {\n      console.warn(\"Service worker update check failed (\" + reason + \"):\", err);\n    });\n  }\n\n  function setupUpdateTriggers() {\n    if (updateCheckTimer) {\n      return;\n    }\n\n    updateCheckTimer = window.setInterval(() => {\n      safeUpdateCheck(\"interval\");\n    }, UPDATE_CHECK_INTERVAL_MS);\n\n    document.addEventListener(\"visibilitychange\", () => {\n      if (document.visibilityState === \"visible\") {\n        safeUpdateCheck(\"visibility\");\n      }\n    });\n\n    window.addEventListener(\"online\", () => {\n      safeUpdateCheck(\"online\");\n    });\n\n    window.addEventListener(\"beforeunload\", () => {\n      if (updateCheckTimer) {\n        window.clearInterval(updateCheckTimer);\n        updateCheckTimer = null;\n      }\n    });\n  }\n\n  function handleRegistration(reg) {\n    if (!reg) {\n      return;\n    }\n\n    activeRegistration = reg;\n\n    if (reg.waiting) {\n      notifyUpdate();\n    }\n\n    attachInstalledListener(reg.installing);\n\n    if (typeof reg.addEventListener === \"function\") {\n      reg.addEventListener(\"updatefound\", () => {\n        attachInstalledListener(reg.installing);\n      });\n    }\n\n    if (!navigator.serviceWorker.controller) {\n      navigator.serviceWorker.ready\n        .then(() => {\n          if (navigator.serviceWorker.controller) {\n            notifyReady();\n          }\n        })\n        .catch(() => {\n          // Ignore ready failures.\n        });\n    }\n\n    navigator.serviceWorker.addEventListener(\"controllerchange\", () => {\n      updateNotified = false;\n    });\n\n    setupUpdateTriggers();\n    safeUpdateCheck(\"post-register\");\n  }\n\n  function registerServiceWorker() {\n    navigator.serviceWorker\n      .register(\"/sw.js\", { scope: \"/\" })\n      .then(handleRegistration)\n      .catch((err) => {\n        console.error(\"Service Worker registration failed:\", err);\n      });\n  }\n\n  if (document.readyState === \"complete\") {\n    registerServiceWorker();\n  } else {\n    window.addEventListener(\"load\", registerServiceWorker, { once: true });\n  }\n})();\n"]}