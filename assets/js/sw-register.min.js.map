{"version":3,"file":"sw-register.min.js","names":["navigator","window","isSecureContext","console","warn","docLang","document","documentElement","getAttribute","toLowerCase","navLang","language","isFa","indexOf","safeToast","message","createToast","notifyReady","notifyUpdate","attachInstalledListener","worker","addEventListener","onStateChange","state","serviceWorker","controller","removeEventListener","handleRegistration","reg","waiting","installing","ready","then","catch","register","err","error"],"sources":["sw-register.js"],"mappings":"CAGA,WACE,aAGA,KAAM,kBAAmBA,WACvB,OAIF,IAAKC,OAAOC,gBAIV,YAHAC,QAAQC,KACN,kEAKJ,MAGMC,GAHOC,SAASC,gBAGAC,aAAa,SAAW,IAAIC,cAC5CC,GAAWV,UAAUW,UAAY,IAAIF,cAErCG,EAA8B,KADvBP,GAAWK,GACNG,QAAQ,MAM1B,SAASC,EAAUC,GACiB,mBAAvBd,OAAOe,aAChBf,OAAOe,YAAYD,EAEvB,CAEA,SAASE,IACPH,EAAUF,EAAO,0BAA4B,0BAC/C,CAEA,SAASM,IACPJ,EACEF,EACI,6DACA,4CAER,CAMA,SAASO,EAAwBC,GAC1BA,GAiBLA,EAAOC,iBAAiB,cAfxB,SAASC,IACc,cAAjBF,EAAOG,QAGPvB,UAAUwB,cAAcC,WAC1BP,IAGAD,IAIFG,EAAOM,oBAAoB,cAAeJ,GAC5C,EAGF,CAMA,SAASK,EAAmBC,GACrBA,IAGDA,EAAIC,SACNX,IAIFC,EAAwBS,EAAIE,YAGQ,mBAAzBF,EAAIP,kBACbO,EAAIP,iBAAiB,cAAe,WAClCF,EAAwBS,EAAIE,WAC9B,GAIG9B,UAAUwB,cAAcC,YAC3BzB,UAAUwB,cAAcO,MACrBC,KAAK,WAEChC,UAAUwB,cAAcC,YAC3BR,GAEJ,GACCgB,MAAM,WAEP,GAIJjC,UAAUwB,cAAcH,iBAAiB,mBAAoB,WAK7D,GACF,CAGApB,OAAOoB,iBAAiB,OAAQ,WAC9BrB,UAAUwB,cACPU,SAAS,UACTF,KAAKL,GACLM,MAAM,SAAUE,GACfhC,QAAQiC,MAAM,sCAAuCD,EACvD,EACJ,EACD,CA7HD","ignoreList":[],"sourcesContent":["// js/sw-register.js\r\n// Safe, robust Service Worker registration with update notifications\r\n\r\n(function () {\r\n  \"use strict\";\r\n\r\n  // Feature & security checks\r\n  if (!(\"serviceWorker\" in navigator)) {\r\n    return;\r\n  }\r\n\r\n  // SW only works on HTTPS (or localhost)\r\n  if (!window.isSecureContext) {\r\n    console.warn(\r\n      \"Service workers require a secure context (HTTPS or localhost).\"\r\n    );\r\n    return;\r\n  }\r\n\r\n  const root = document.documentElement;\r\n\r\n  // زبان صفحه: اول lang روی <html> بعد navigator.language\r\n  const docLang = (root.getAttribute(\"lang\") || \"\").toLowerCase();\r\n  const navLang = (navigator.language || \"\").toLowerCase();\r\n  const lang = docLang || navLang;\r\n  const isFa = lang.indexOf(\"fa\") === 0;\r\n\r\n  /**\r\n   * Safely display toast notification\r\n   * @param {string} message - Message to display\r\n   */\r\n  function safeToast(message) {\r\n    if (typeof window.createToast === \"function\") {\r\n      window.createToast(message);\r\n    }\r\n  }\r\n\r\n  function notifyReady() {\r\n    safeToast(isFa ? \"پشتیبانی آفلاین فعال شد\" : \"Offline support enabled\");\r\n  }\r\n\r\n  function notifyUpdate() {\r\n    safeToast(\r\n      isFa\r\n        ? \"نسخهٔ جدید در دسترس است. برای بروزرسانی صفحه را تازه کنید.\"\r\n        : \"New version available. Refresh to update.\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Attach \"installed\" listener to a worker (if present)\r\n   * @param {ServiceWorker | null | undefined} worker\r\n   */\r\n  function attachInstalledListener(worker) {\r\n    if (!worker) return;\r\n\r\n    function onStateChange() {\r\n      if (worker.state !== \"installed\") return;\r\n\r\n      // If controller exists, this is an update\r\n      if (navigator.serviceWorker.controller) {\r\n        notifyUpdate();\r\n      } else {\r\n        // First installation: offline support enabled\r\n        notifyReady();\r\n      }\r\n\r\n      // بعد از رسیدن به installed، دیگر نیازی به لیسنر نیست\r\n      worker.removeEventListener(\"statechange\", onStateChange);\r\n    }\r\n\r\n    worker.addEventListener(\"statechange\", onStateChange);\r\n  }\r\n\r\n  /**\r\n   * Handle Service Worker registration and updates\r\n   * @param {ServiceWorkerRegistration} reg - Registration object\r\n   */\r\n  function handleRegistration(reg) {\r\n    if (!reg) return;\r\n\r\n    // If waiting worker exists, update is available (e.g. from previous visit)\r\n    if (reg.waiting) {\r\n      notifyUpdate();\r\n    }\r\n\r\n    // اگر همین الان در حال نصب باشد (before we attached 'updatefound')\r\n    attachInstalledListener(reg.installing);\r\n\r\n    // Listen for future updates\r\n    if (typeof reg.addEventListener === \"function\") {\r\n      reg.addEventListener(\"updatefound\", function () {\r\n        attachInstalledListener(reg.installing);\r\n      });\r\n    }\r\n\r\n    // Edge-case: سرویس‌ورکر فعال است ولی controller نداریم\r\n    if (!navigator.serviceWorker.controller) {\r\n      navigator.serviceWorker.ready\r\n        .then(function () {\r\n          // اگر هنوز controller نداریم یعنی این تب تازه تحت کنترل قرار گرفته\r\n          if (!navigator.serviceWorker.controller) {\r\n            notifyReady();\r\n          }\r\n        })\r\n        .catch(function () {\r\n          // ignore\r\n        });\r\n    }\r\n\r\n    // Optional: گوش دادن به تغییر controller برای توسعه‌های بعدی (auto-refresh و غیره)\r\n    navigator.serviceWorker.addEventListener(\"controllerchange\", function () {\r\n      // در صورت نیاز می‌تونی اینجا لاجیک اضافه کنی\r\n      // مثلاً:\r\n      // notifyUpdate();\r\n      // یا auto-refresh: window.location.reload();\r\n    });\r\n  }\r\n\r\n  // Register Service Worker when window has fully loaded\r\n  window.addEventListener(\"load\", function () {\r\n    navigator.serviceWorker\r\n      .register(\"/sw.js\")\r\n      .then(handleRegistration)\r\n      .catch(function (err) {\r\n        console.error(\"Service Worker registration failed:\", err);\r\n      });\r\n  });\r\n})();\r\n"]}