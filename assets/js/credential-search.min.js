document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("credential-search"),t=document.getElementById("clear-credential-search"),n=document.getElementById("voice-search-btn"),a=document.getElementById("results-info"),r=document.querySelectorAll(".credential-card"),o=a?.dataset.lang||document.documentElement.lang||"en";if(!e||!t)return;const i="credentialSearchTerm";function s(){const e="__credential_search__";try{return localStorage.setItem(e,e),localStorage.removeItem(e),localStorage}catch(e){return null}}const l=s(),c=l?.getItem(i)||"";let d;c&&(e.value=c,t.style.display="block");const u=e=>(e||"").normalize("NFC").replace(/[ي]/g,"ی").replace(/[ك]/g,"ک").replace(/[\u064B-\u065F\u0670]/g,"").replace(/‌/g,""),m=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");r.forEach(e=>{const t=e.querySelector("h3"),n=e.querySelector(".credential-summary");t&&(t.dataset.original=t.textContent),n&&(n.dataset.original=n.textContent)});const y=(e,t)=>{if(!e||!e.dataset.original)return;if(!t)return void(e.innerHTML=e.dataset.original);const n=new RegExp(`(${m(t)})`,"gi");e.innerHTML=e.dataset.original.replace(n,"<mark>$1</mark>")},f=e=>{if(a)if(o.startsWith("fa"))a.textContent=0===e?"موردی یافت نشد":`${e} نتیجه یافت شد`;else{const t=1===e?"result":"results";a.textContent=0===e?"No results found":`${e} ${t} found`}},v=t=>{const n=void 0!==t?t:e.value.trim(),a=u(n).toLowerCase();let o=0;r.forEach(e=>{const t=e.querySelector("h3"),r=e.querySelector(".credential-summary"),i=u(e.dataset.keywords||"").toLowerCase(),s=t?u(t.dataset.original).toLowerCase():"",l=r?u(r.dataset.original).toLowerCase():"";s.includes(a)||l.includes(a)||i.includes(a)?(e.style.display="grid",y(t,n),y(r,n),o++):(e.style.display="none",y(t,""),y(r,""))}),f(o)};if(e.addEventListener("input",()=>{const n=e.value.trim();if(t.style.display=n?"block":"none",l)try{n?l.setItem(i,n):l.removeItem(i)}catch(e){}clearTimeout(d),d=setTimeout(()=>v(n),200)}),t.addEventListener("click",()=>{if(e.value="",t.style.display="none",l)try{l.removeItem(i)}catch(e){}clearTimeout(d),v("")}),e.addEventListener("keydown",n=>{if("Escape"===n.key){if(e.value="",t.style.display="none",l)try{l.removeItem(i)}catch(e){}clearTimeout(d),v("")}else if((n.ctrlKey||n.metaKey)&&"l"===n.key.toLowerCase()){if(n.preventDefault(),e.value="",t.style.display="none",l)try{l.removeItem(i)}catch(e){}clearTimeout(d),v("")}}),n){const a=window.SpeechRecognition||window.webkitSpeechRecognition;if(a){const r=new a;r.lang=o.startsWith("fa")?"fa-IR":"en-US",r.interimResults=!1,n.addEventListener("click",()=>r.start()),r.addEventListener("start",()=>{n.classList.add("listening")}),r.addEventListener("end",()=>{n.classList.remove("listening")}),r.addEventListener("result",n=>{const a=n.results[0][0].transcript.trim();if(e.value=a,t.style.display=a?"block":"none",l)try{a?l.setItem(i,a):l.removeItem(i)}catch(e){}v(a)}),r.addEventListener("error",()=>{window.createToast?.(o.startsWith("fa")?"امکان دریافت صدا نیست.":"Voice recognition unavailable.",{id:`voice-error-${Date.now()}`,iconClass:"fas fa-exclamation-triangle",iconColor:"red",duration:3e3})})}else n.style.display="none",window.createToast?.(o.startsWith("fa")?"مرورگر شما از جستجوی صوتی پشتیبانی نمی‌کند.":"Voice search isn't supported.",{id:"voice-unsupported",iconClass:"fas fa-exclamation-triangle",iconColor:"red",duration:3e3})}document.addEventListener("keydown",n=>{if(("/"===n.key||"k"===n.key.toLowerCase()&&(n.ctrlKey||n.metaKey))&&document.activeElement!==e)n.preventDefault(),e.focus();else if("Escape"===n.key&&document.activeElement===e){if(e.value="",t.style.display="none",l)try{l.removeItem(i)}catch(e){}v("")}else if((n.ctrlKey||n.metaKey)&&"l"===n.key.toLowerCase()){if(n.preventDefault(),e.value="",t.style.display="none",l)try{l.removeItem(i)}catch(e){}v("")}}),v(c)});