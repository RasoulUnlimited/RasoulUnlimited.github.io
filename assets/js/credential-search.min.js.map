{"version":3,"file":"credential-search.min.js","names":["window","document","addEventListener","searchInput","getElementById","clearButton","voiceButton","resultsInfo","cards","querySelectorAll","lang","dataset","documentElement","length","isFarsi","toLowerCase","startsWith","STORAGE_KEY","setAttribute","storage","testKey","localStorage","setItem","removeItem","getSafeStorage","safeToast","message","options","createToast","normalizeText","str","normalize","replace","highlightText","el","term","forEach","mark","parent","parentNode","replaceChild","createTextNode","textContent","walker","createTreeWalker","NodeFilter","SHOW_TEXT","nodesToReplace","pattern","split","map","char","escaped","join","regex","RegExp","nextNode","node","currentNode","nodeValue","classList","contains","lastIndex","test","push","fragment","createDocumentFragment","part","index","createElement","className","appendChild","credentialItems","debounceTimer","card","nameEl","querySelector","summaryEl","original","searchIndex","keywords","filter","Boolean","persistTerm","filterCards","searchTerm","undefined","value","trim","searchNormalized","visibleCount","item","includes","style","display","count","word","updateResultsInfo","clearSearch","clearTimeout","focus","recognition","cleanupHandlers","savedTerm","getItem","initStorageAndInitialState","setTimeout","e","key","preventDefault","SpeechRecognition","webkitSpeechRecognition","interimResults","handleClickStart","start","handleStart","add","handleEnd","remove","handleResult","transcript","results","handleError","err","error","abort","removeEventListener","initVoiceSearch","handler","active","activeElement","ctrlKey","metaKey","tag","tagName","isContentEditable","isInputLike","initKeyboardShortcuts","fn"],"sources":["credential-search.js"],"mappings":"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","ignoreList":[],"sourcesContent":["// Minimal credential search functionality\r\n// Similar to faq-search.js but for proof pages\r\n\r\n(function () {\r\n  \"use strict\";\r\n\r\n  // جلوگیری از ارور در محیط‌هایی مثل SSR/Node\r\n  if (typeof window === \"undefined\" || typeof document === \"undefined\") {\r\n    return;\r\n  }\r\n\r\n  document.addEventListener(\"DOMContentLoaded\", function () {\r\n    const searchInput = document.getElementById(\"credential-search\");\r\n    const clearButton = document.getElementById(\"clear-credential-search\");\r\n    const voiceButton = document.getElementById(\"voice-search-btn\");\r\n    const resultsInfo = document.getElementById(\"results-info\");\r\n    const cards = document.querySelectorAll(\".credential-card\");\r\n\r\n    const lang =\r\n      (resultsInfo && resultsInfo.dataset.lang) ||\r\n      document.documentElement.lang ||\r\n      \"en\";\r\n\r\n    if (!searchInput || !clearButton || !cards.length) return;\r\n\r\n    const isFarsi = lang.toLowerCase().startsWith(\"fa\");\r\n    const STORAGE_KEY = \"credentialSearchTerm\";\r\n\r\n    // Make results info a live region for screen readers\r\n    if (resultsInfo) {\r\n      resultsInfo.setAttribute(\"aria-live\", \"polite\");\r\n      resultsInfo.setAttribute(\"aria-atomic\", \"true\");\r\n    }\r\n\r\n    function getSafeStorage() {\r\n      const testKey = \"__credential_search__\";\r\n      try {\r\n        localStorage.setItem(testKey, testKey);\r\n        localStorage.removeItem(testKey);\r\n        return localStorage;\r\n      } catch {\r\n        return null;\r\n      }\r\n    }\r\n\r\n    const storage = getSafeStorage();\r\n\r\n    /**\r\n     * Safe wrapper for createToast (works with 1-arg or 2-arg versions)\r\n     * @param {string} message\r\n     * @param {any} [options]\r\n     */\r\n    function safeToast(message, options) {\r\n      if (!message || typeof window.createToast !== \"function\") return;\r\n      try {\r\n        return window.createToast(message, options);\r\n      } catch {\r\n        try {\r\n          return window.createToast(message);\r\n        } catch {\r\n          // ignore\r\n        }\r\n      }\r\n    }\r\n\r\n    // نرمالایز برای سرچ (فارسی + حذف حرکات و ZWNJ)\r\n    const normalizeText = (str) =>\r\n      (str || \"\")\r\n        .normalize(\"NFC\")\r\n        .replace(/[ي]/g, \"ی\")\r\n        .replace(/[ك]/g, \"ک\")\r\n        .replace(/[\\u064B-\\u065F\\u0670]/g, \"\") // حذف حرکات\r\n        .replace(/‌/g, \"\") // حذف ZWNJ\r\n        .toLowerCase();\r\n\r\n    const escapeRegExp = (str) => str.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n\r\n    const isInputLike = (el) => {\r\n      if (!el) return false;\r\n      const tag = el.tagName;\r\n      return (\r\n        tag === \"INPUT\" ||\r\n        tag === \"TEXTAREA\" ||\r\n        el.isContentEditable === true\r\n      );\r\n    };\r\n\r\n    /**\r\n     * حذف هایلایت‌های قبلی و اعمال هایلایت جدید روی متن\r\n     * هایلایت طوری انجام می‌شود که ساختار DOM کلی حفظ شود (کمترین تخریب)\r\n     * @param {HTMLElement | null} el\r\n     * @param {string} term\r\n     */\r\n    const highlightText = (el, term) => {\r\n      if (!el) return;\r\n\r\n      // حذف هایلایت‌های قبلی\r\n      const highlights = el.querySelectorAll(\"mark.search-highlight\");\r\n      highlights.forEach((mark) => {\r\n        const parent = mark.parentNode;\r\n        if (!parent) return;\r\n        parent.replaceChild(\r\n          document.createTextNode(mark.textContent || \"\"),\r\n          mark\r\n        );\r\n        parent.normalize();\r\n      });\r\n\r\n      if (!term) return;\r\n\r\n      const walker = document.createTreeWalker(\r\n        el,\r\n        NodeFilter.SHOW_TEXT,\r\n        null,\r\n        false\r\n      );\r\n\r\n      const nodesToReplace = [];\r\n      const normalizedTerm = normalizeText(term);\r\n\r\n      // ساخت pattern که اجازهٔ حرکات / ZWNJ بین کاراکترها را می‌دهد\r\n      const noise = \"[\\\\u064B-\\\\u065F\\\\u0670\\\\u200c\\\\u200d]*\";\r\n      const pattern = normalizedTerm\r\n        .split(\"\")\r\n        .map((char) => {\r\n          const escaped = escapeRegExp(char);\r\n          if (char === \"ی\") return \"[یي]\";\r\n          if (char === \"ک\") return \"[کك]\";\r\n          return escaped;\r\n        })\r\n        .join(noise);\r\n\r\n      if (!pattern) return;\r\n\r\n      // از g استفاده می‌کنیم ولی قبل از هر استفاده lastIndex را صفر می‌کنیم تا stateful بودن اذیت نکند\r\n      const regex = new RegExp(`(${pattern})`, \"gi\");\r\n\r\n      while (walker.nextNode()) {\r\n        const node = walker.currentNode;\r\n\r\n        if (\r\n          !node.nodeValue ||\r\n          (node.parentNode &&\r\n            node.parentNode.classList &&\r\n            node.parentNode.classList.contains(\"search-highlight\"))\r\n        ) {\r\n          continue;\r\n        }\r\n\r\n        regex.lastIndex = 0;\r\n        if (regex.test(node.nodeValue)) {\r\n          nodesToReplace.push(node);\r\n        }\r\n      }\r\n\r\n      nodesToReplace.forEach((node) => {\r\n        if (!node.parentNode) return;\r\n\r\n        const fragment = document.createDocumentFragment();\r\n        regex.lastIndex = 0;\r\n        const parts = node.nodeValue.split(regex);\r\n\r\n        parts.forEach((part, index) => {\r\n          if (index % 2 === 1) {\r\n            // matched segment\r\n            const mark = document.createElement(\"mark\");\r\n            mark.className = \"search-highlight\";\r\n            mark.textContent = part;\r\n            fragment.appendChild(mark);\r\n          } else if (part) {\r\n            fragment.appendChild(document.createTextNode(part));\r\n          }\r\n        });\r\n\r\n        node.parentNode.replaceChild(fragment, node);\r\n      });\r\n    };\r\n\r\n    const updateResultsInfo = (count) => {\r\n      if (!resultsInfo) return;\r\n      if (isFarsi) {\r\n        resultsInfo.textContent =\r\n          count === 0 ? \"موردی یافت نشد\" : `${count} نتیجه یافت شد`;\r\n      } else {\r\n        const word = count === 1 ? \"result\" : \"results\";\r\n        resultsInfo.textContent =\r\n          count === 0 ? \"No results found\" : `${count} ${word} found`;\r\n      }\r\n    };\r\n\r\n    // --- Precompute card meta to avoid repeated querySelector در هر سرچ ---\r\n\r\n    /**\r\n     * @typedef {Object} CredentialItem\r\n     * @property {HTMLElement} card\r\n     * @property {HTMLElement | null} nameEl\r\n     * @property {HTMLElement | null} summaryEl\r\n     * @property {string} searchIndex\r\n     */\r\n\r\n    /** @type {CredentialItem[]} */\r\n    const credentialItems = [];\r\n\r\n    cards.forEach((card) => {\r\n      const nameEl = card.querySelector(\"h3\");\r\n      const summaryEl = card.querySelector(\".credential-summary\");\r\n\r\n      if (nameEl && !nameEl.dataset.original) {\r\n        nameEl.dataset.original = nameEl.textContent || \"\";\r\n      }\r\n      if (summaryEl && !summaryEl.dataset.original) {\r\n        summaryEl.dataset.original = summaryEl.textContent || \"\";\r\n      }\r\n\r\n      const normalizedName = nameEl?.dataset.original\r\n        ? normalizeText(nameEl.dataset.original)\r\n        : \"\";\r\n      const normalizedSummary = summaryEl?.dataset.original\r\n        ? normalizeText(summaryEl.dataset.original)\r\n        : \"\";\r\n      const normalizedKeywords = normalizeText(card.dataset.keywords || \"\");\r\n\r\n      const searchIndex = [normalizedName, normalizedSummary, normalizedKeywords]\r\n        .filter(Boolean)\r\n        .join(\" \");\r\n\r\n      card.dataset.searchIndex = searchIndex;\r\n\r\n      credentialItems.push({\r\n        card,\r\n        nameEl: nameEl || null,\r\n        summaryEl: summaryEl || null,\r\n        searchIndex,\r\n      });\r\n    });\r\n\r\n    let debounceTimer;\r\n\r\n    const persistTerm = (term) => {\r\n      if (!storage) return;\r\n      try {\r\n        if (term) {\r\n          storage.setItem(STORAGE_KEY, term);\r\n        } else {\r\n          storage.removeItem(STORAGE_KEY);\r\n        }\r\n      } catch {\r\n        // ignore storage errors (e.g. Safari private mode)\r\n      }\r\n    };\r\n\r\n    const filterCards = (term) => {\r\n      const searchTerm =\r\n        term !== undefined ? term : searchInput.value.trim() || \"\";\r\n      const searchNormalized = normalizeText(searchTerm);\r\n      let visibleCount = 0;\r\n\r\n      credentialItems.forEach((item) => {\r\n        const { card, nameEl, summaryEl, searchIndex } = item;\r\n        const matches =\r\n          !searchNormalized || searchIndex.includes(searchNormalized);\r\n\r\n        if (matches) {\r\n          card.style.display = \"grid\";\r\n          highlightText(nameEl, searchTerm);\r\n          highlightText(summaryEl, searchTerm);\r\n          visibleCount++;\r\n        } else {\r\n          card.style.display = \"none\";\r\n          highlightText(nameEl, \"\");\r\n          highlightText(summaryEl, \"\");\r\n        }\r\n      });\r\n\r\n      updateResultsInfo(visibleCount);\r\n    };\r\n\r\n    const clearSearch = () => {\r\n      searchInput.value = \"\";\r\n      clearButton.style.display = \"none\";\r\n      clearTimeout(debounceTimer);\r\n      persistTerm(\"\");\r\n      filterCards(\"\");\r\n      searchInput.focus();\r\n    };\r\n\r\n    // --- Initial state from storage ---\r\n    const initStorageAndInitialState = () => {\r\n      const savedTerm = storage?.getItem(STORAGE_KEY) || \"\";\r\n      if (savedTerm) {\r\n        searchInput.value = savedTerm;\r\n        clearButton.style.display = \"block\";\r\n      }\r\n      filterCards(savedTerm);\r\n    };\r\n\r\n    // --- Text search events ---\r\n    const initTextSearch = () => {\r\n      searchInput.addEventListener(\"input\", () => {\r\n        const term = searchInput.value.trim();\r\n        clearButton.style.display = term ? \"block\" : \"none\";\r\n        persistTerm(term);\r\n\r\n        clearTimeout(debounceTimer);\r\n        debounceTimer = setTimeout(() => filterCards(term), 200);\r\n      });\r\n\r\n      clearButton.addEventListener(\"click\", clearSearch);\r\n\r\n      searchInput.addEventListener(\"keydown\", (e) => {\r\n        if (e.key === \"Escape\") {\r\n          e.preventDefault();\r\n          clearSearch();\r\n        }\r\n      });\r\n    };\r\n\r\n    // --- Voice search ---\r\n    let recognition = null;\r\n\r\n    // --- Cleanup handler list ---\r\n    const cleanupHandlers = [];\r\n\r\n    const initVoiceSearch = () => {\r\n      if (!voiceButton) return;\r\n\r\n      const SpeechRecognition =\r\n        window.SpeechRecognition || window.webkitSpeechRecognition;\r\n\r\n      if (!SpeechRecognition) {\r\n        voiceButton.style.display = \"none\";\r\n        safeToast(\r\n          isFarsi\r\n            ? \"مرورگر شما از جستجوی صوتی پشتیبانی نمی‌کند.\"\r\n            : \"Voice search isn't supported.\"\r\n        );\r\n        return;\r\n      }\r\n\r\n      recognition = new SpeechRecognition();\r\n      recognition.lang = isFarsi ? \"fa-IR\" : \"en-US\";\r\n      recognition.interimResults = false;\r\n\r\n      const handleClickStart = () => {\r\n        try {\r\n          recognition.start();\r\n        } catch {\r\n          // اگر در حال اجرا بود، خطا را نادیده می‌گیریم\r\n        }\r\n      };\r\n\r\n      const handleStart = () => {\r\n        voiceButton.classList.add(\"listening\");\r\n        voiceButton.setAttribute(\"aria-pressed\", \"true\");\r\n      };\r\n\r\n      const handleEnd = () => {\r\n        voiceButton.classList.remove(\"listening\");\r\n        voiceButton.setAttribute(\"aria-pressed\", \"false\");\r\n      };\r\n\r\n      const handleResult = (e) => {\r\n        const transcript = (e.results[0][0].transcript || \"\").trim();\r\n        searchInput.value = transcript;\r\n        clearButton.style.display = transcript ? \"block\" : \"none\";\r\n        persistTerm(transcript);\r\n\r\n        clearTimeout(debounceTimer);\r\n        // برای تجربه‌ی بهتر، نتایج صوتی را بدون debounce اعمال می‌کنیم\r\n        filterCards(transcript);\r\n      };\r\n\r\n      const handleError = (err) => {\r\n        if (err && (err.error === \"no-speech\" || err.error === \"aborted\")) {\r\n          return;\r\n        }\r\n        safeToast(\r\n          isFarsi\r\n            ? \"امکان دریافت صدا نیست.\"\r\n            : \"Voice recognition unavailable.\"\r\n        );\r\n      };\r\n\r\n      voiceButton.addEventListener(\"click\", handleClickStart);\r\n      recognition.addEventListener(\"start\", handleStart);\r\n      recognition.addEventListener(\"end\", handleEnd);\r\n      recognition.addEventListener(\"result\", handleResult);\r\n      recognition.addEventListener(\"error\", handleError);\r\n\r\n      // ثبت برای cleanup\r\n      cleanupHandlers.push(() => {\r\n        try {\r\n          recognition.abort();\r\n        } catch {\r\n          // Ignore errors during abort\r\n        }\r\n        voiceButton.removeEventListener(\"click\", handleClickStart);\r\n        recognition.removeEventListener(\"start\", handleStart);\r\n        recognition.removeEventListener(\"end\", handleEnd);\r\n        recognition.removeEventListener(\"result\", handleResult);\r\n        recognition.removeEventListener(\"error\", handleError);\r\n      });\r\n    };\r\n\r\n    // --- Global keyboard shortcuts: / or Ctrl/Cmd+K to focus search ---\r\n    const initKeyboardShortcuts = () => {\r\n      const handler = (e) => {\r\n        const active = document.activeElement;\r\n\r\n        if (\r\n          (e.key === \"/\" ||\r\n            (e.key.toLowerCase() === \"k\" && (e.ctrlKey || e.metaKey))) &&\r\n          !isInputLike(active) &&\r\n          active !== searchInput\r\n        ) {\r\n          e.preventDefault();\r\n          searchInput.focus();\r\n          return;\r\n        }\r\n\r\n        if (e.key === \"Escape\" && active === searchInput) {\r\n          e.preventDefault();\r\n          clearSearch();\r\n        }\r\n      };\r\n\r\n      document.addEventListener(\"keydown\", handler);\r\n\r\n      cleanupHandlers.push(() => {\r\n        document.removeEventListener(\"keydown\", handler);\r\n      });\r\n    };\r\n\r\n    const initGlobalCleanup = () => {\r\n      window.addEventListener(\"beforeunload\", () => {\r\n        clearTimeout(debounceTimer);\r\n        cleanupHandlers.forEach((fn) => {\r\n          try {\r\n            fn();\r\n          } catch {\r\n            // ignore individual cleanup errors\r\n          }\r\n        });\r\n      });\r\n    };\r\n\r\n    // --- Init all ---\r\n    initStorageAndInitialState();\r\n    initTextSearch();\r\n    initVoiceSearch();\r\n    initKeyboardShortcuts();\r\n    initGlobalCleanup();\r\n  });\r\n})();\r\n"]}